<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>David P. Hoffman, PhD.</title>
    <link>https://david-hoffman.github.io/authors/admin/</link>
    <description>Recent content on David P. Hoffman, PhD.</description>
    <generator>Source Themes academia (https://sourcethemes.com/academic/)</generator>
    <language>en-us</language>
    <copyright>&amp;copy; {year} David P. Hoffman</copyright>
    
	    <atom:link href="https://david-hoffman.github.io/authors/admin/index.xml" rel="self" type="application/rss+xml" />
    
    
    <item>
      <title>Don&#39;t Deconvolve Your PSF</title>
      <link>https://david-hoffman.github.io/post/dont-deconvolve-your-psf/</link>
      <pubDate>Wed, 15 Jul 2020 14:21:08 -0700</pubDate>
      
      <guid>https://david-hoffman.github.io/post/dont-deconvolve-your-psf/</guid>
      <description>&lt;blockquote&gt;
&lt;h2 id=&#34;post-processing-cannot-increase-information&#34;&gt;Post-processing cannot increase information&lt;/h2&gt;
&lt;p&gt;&lt;em&gt;‚Äî &lt;a href=&#34;https://en.wikipedia.org/wiki/Data_processing_inequality&#34;&gt;Normand Beaudry&lt;/a&gt;&lt;/em&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;This is axiomatic in science generally, but especially in microscopy.&lt;/p&gt;
&lt;p&gt;At it&amp;rsquo;s core a microscope is a low pass filter, and what it&amp;rsquo;s filtering is spatial information. A sample&amp;rsquo;s structure (that&amp;rsquo;s what you&amp;rsquo;re trying to measure with a microscope) is made up of various &lt;a href=&#34;https://en.wikipedia.org/wiki/Spatial_frequency&#34;&gt;spatial frequencies&lt;/a&gt; and the microscope, due to the wave nature of light, can only capture the lower frequency ones (remember, higher spatial frequencies &lt;em&gt;are the Fourier representation of higher resolution information&lt;/em&gt;). The upper limit of spatial frequencies that a microscope can transmit is known as the &lt;a href=&#34;https://en.wikipedia.org/wiki/Diffraction-limited_system#The_Abbe_diffraction_limit_for_a_microscope&#34;&gt;&lt;em&gt;diffraction limit&lt;/em&gt;&lt;/a&gt;. Super-resolution microscopes bypass this limit by cleverly encoding higher spatial frequencies such that they fall into the pass-band of the microscope. Regardless, every microscope, even a &amp;ldquo;super&amp;rdquo; one, has a maximum spatial frequency which it can transmit.&lt;sup id=&#34;fnref:1&#34;&gt;&lt;a href=&#34;#fn:1&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;1&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;
&lt;p&gt;What&amp;rsquo;s all this got to do with deconvolution? Well I&amp;rsquo;ve seen a few people, papers, and even microscope companies making claims that deconvolution will improve the &lt;em&gt;resolution&lt;/em&gt; of your data.&lt;sup id=&#34;fnref:2&#34;&gt;&lt;a href=&#34;#fn:2&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;2&lt;/a&gt;&lt;/sup&gt; Unfortunately, this is üê¥üí©. A microscope&amp;rsquo;s resolution is &lt;em&gt;fundamentally&lt;/em&gt; limited by &lt;strong&gt;the laws of physics&lt;/strong&gt;. You cannot recover information that was &lt;em&gt;never&lt;/em&gt; present in the first place.&lt;sup id=&#34;fnref:3&#34;&gt;&lt;a href=&#34;#fn:3&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;3&lt;/a&gt;&lt;/sup&gt; To make matters worse most of these offenders will use the &lt;a href=&#34;https://en.wikipedia.org/wiki/Point_spread_function&#34;&gt;point spread function&lt;/a&gt; (PSF), the ultimate arbiter of microscope performance, to &lt;em&gt;demonstrate&lt;/em&gt; this improvement. What I mean is, they&amp;rsquo;ll show a side-by-side comparison of the raw PSF and the deconvolved PSF. What do you think will happen if you run an iterative deconvolution algorithm with the kernel and image being the same? If they&amp;rsquo;re identical you&amp;rsquo;ll get a single bright pixel! Even if they&amp;rsquo;re just similar you&amp;rsquo;ll get a fantastical result and if you&amp;rsquo;re not careful, you might look at that result and think,&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Gee, this deconvolution thing sure is swell! It turned this blurry, ugly PSF into a sharp, beautiful one! I can&amp;rsquo;t wait to buy this expensive microscope and/or software and try it out on &lt;em&gt;my&lt;/em&gt; data because I&amp;rsquo;ll see the same improvement in resolution!&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Unfortunately for you, if you did think this, you&amp;rsquo;d be wrong; very, &lt;em&gt;very&lt;/em&gt; wrong.&lt;/p&gt;
&lt;p&gt;To make this concrete, let&amp;rsquo;s look at an example (Fig 1.). Here I&amp;rsquo;ve generated a simulated widefield epi-fluorescent PSF&lt;sup id=&#34;fnref:4&#34;&gt;&lt;a href=&#34;#fn:4&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;4&lt;/a&gt;&lt;/sup&gt; (top) and the corresponding &lt;a href=&#34;https://en.wikipedia.org/wiki/Optical_transfer_function&#34;&gt;optical transfer function&lt;/a&gt; (OTF, bottom) for a 1.46 NA oil objective (left column) at a pixel size of 40 nm and an emission wavelength of 525 nm (same as GFP). Next (middle column) I&amp;rsquo;ve simulated an image of a point source; essentially this is just the PSF with added &lt;a href=&#34;https://en.wikipedia.org/wiki/Shot_noise&#34;&gt;shot noise&lt;/a&gt; and &lt;a href=&#34;http://camera.hamamatsu.com/us/en/camera_simulation_engine/index.html&#34;&gt;camera noise&lt;/a&gt; for an &lt;a href=&#34;https://www.pco-tech.com/scientific-cameras/pcoedge-42-bi/&#34;&gt;sCMOS camera&lt;/a&gt;. Note that for both the ground truth PSF (left column) and simulated image of a point emitter (middle column) the OTF is bounded by the traditional Abbe diffraction limit (white circle, bottom row). However, if I deconvolve&lt;sup id=&#34;fnref:5&#34;&gt;&lt;a href=&#34;#fn:5&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;5&lt;/a&gt;&lt;/sup&gt; the image (middle column) with the PSF (left column) you can see that the result exceeds the traditional diffraction limit (right column), substantially.&lt;/p&gt;






&lt;figure&gt;

  &lt;a data-fancybox=&#34;&#34; href=&#34;Simulated%20PSF%20Plot.png&#34; &gt;

&lt;img src=&#34;Simulated%20PSF%20Plot.png&#34; &gt;
&lt;/a&gt;


&lt;figcaption data-pre=&#34;Figure &#34; data-post=&#34;:&#34; class=&#34;numbered&#34;&gt;
  &lt;h4&gt;Simulating the effect of deconvolving an image of a point emitter. A gamma correction of 0.5 was applied to the top row and the bottom row is shown on a logarithmic scale. White lines indicate the Abbe diffraction limit. Scale bar is 1 ¬µm.&lt;/h4&gt;
  
&lt;/figcaption&gt;

&lt;/figure&gt;

&lt;p&gt;&amp;ldquo;Ok,&amp;rdquo; you say, &amp;ldquo;but why do I, as a microscopy user, care about this subterfuge?&amp;rdquo; That&amp;rsquo;s a good question and it leads to my second example (Fig. 2). As my simulated sample (first column) I&amp;rsquo;ve used the ubiquitous &lt;a href=&#34;https://en.wikipedia.org/wiki/1951_USAF_resolution_test_chart&#34;&gt;USAF-1951 target&lt;/a&gt;. The full target is shown on the top row and a zoom of the central ROI (red square) is shown on the bottom row (scale bar is 1 ¬µm). I&amp;rsquo;ve scaled the image such that the finest resolution pattern is 80 nm (160 nm per line pair). Next (second column) I simulate an image of this sample taken by a microscope with the PSF shown in the left column of Fig. 1. Note that the Abbe diffraction limited resolution of this microscope is 180 nm: over two fold worse than the finest pattern shown in the bottom row. Deconvolving the simulated image with the ground truth PSF (third column) results in a definite improvement of &lt;em&gt;contrast&lt;/em&gt;&lt;sup id=&#34;fnref:6&#34;&gt;&lt;a href=&#34;#fn:6&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;6&lt;/a&gt;&lt;/sup&gt; but the line pairs that are unresolved in the original image remain unresolved in the deconvolved image, as expected. Finally, I demonstrate what a deconvolved image might look like if one were to believe the resolution &amp;ldquo;enhancement&amp;rdquo; shown in Fig. 1 (right column). Here, even the finest resolution pattern is clearly resolved. In essence, I&amp;rsquo;ve more than &amp;ldquo;doubled&amp;rdquo; the resolution of the microscope with a simple algorithm; and I didn&amp;rsquo;t need to pay the megabucks for a SIM, STED, or PALM scope!&lt;/p&gt;






&lt;figure&gt;

  &lt;a data-fancybox=&#34;&#34; href=&#34;Simulated%20Image%20Plot.png&#34; &gt;

&lt;img src=&#34;Simulated%20Image%20Plot.png&#34; &gt;
&lt;/a&gt;


&lt;figcaption data-pre=&#34;Figure &#34; data-post=&#34;:&#34; class=&#34;numbered&#34;&gt;
  &lt;h4&gt;Can deconvolution resolve the &amp;ldquo;unresolvable&amp;rdquo;? No, it can&amp;rsquo;t.&lt;/h4&gt;
  
&lt;/figcaption&gt;

&lt;/figure&gt;

&lt;p&gt;Now you might say,&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Oh come one, those are simulations and I won&amp;rsquo;t believe anything except for hard, experimental, evidence!&amp;rdquo;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Sounds like you&amp;rsquo;re my kind of scientist! Lucky for you I&amp;rsquo;ve gone ahead and collected the 3D-PSF of a &lt;a href=&#34;https://www.microscope.healthcare.nikon.com/selectors/objective-comparison/-1848&#34;&gt;0.95 NA air objective&lt;/a&gt; using a sub-diffractive (100 nm) fluorescent bead (left column, Fig. 3). Then I&amp;rsquo;ve deconvolved&lt;sup id=&#34;fnref:7&#34;&gt;&lt;a href=&#34;#fn:7&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;7&lt;/a&gt;&lt;/sup&gt; this image using two different estimates of the PSF: for the first (middle column) I radially averaged the image itself; for the second (right column) I simulated the PSF based on the microscope parameters.&lt;sup id=&#34;fnref:4&#34;&gt;&lt;a href=&#34;#fn:4&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;4&lt;/a&gt;&lt;/sup&gt; In both cases, there is a significant, and yet completely imaginary, &amp;ldquo;improvement&amp;rdquo; in the apparent resolution.&lt;sup id=&#34;fnref:8&#34;&gt;&lt;a href=&#34;#fn:8&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;8&lt;/a&gt;&lt;/sup&gt; Equally troubling is the fact that the &lt;a href=&#34;https://ieeexplore.ieee.org/document/196731&#34;&gt;&amp;ldquo;missing cone&amp;rdquo;&lt;/a&gt; has been completely filled, which erroneously suggests that deconvolution can impart optical sectioning.&lt;/p&gt;






&lt;figure&gt;

  &lt;a data-fancybox=&#34;&#34; href=&#34;Real%20PSF%20Plot.png&#34; &gt;

&lt;img src=&#34;Real%20PSF%20Plot.png&#34; &gt;
&lt;/a&gt;


&lt;figcaption data-pre=&#34;Figure &#34; data-post=&#34;:&#34; class=&#34;numbered&#34;&gt;
  &lt;h4&gt;Does the same thing happen with real data? Sure does! Scale bars are 1 ¬µm and 1 ¬µm$^{-1}$, respectively.&lt;/h4&gt;
  
&lt;/figcaption&gt;

&lt;/figure&gt;

&lt;p&gt;Deconvolution is a powerful tool, but like all powerful tools it can be powerfully misused. The resolution of an imaging system is limited by physics and, unfortunately, cannot be improved with algorithms. Deconvolution is an extremely useful tool to improve your images (it denoises while increasing contrast! ü§©) and can be an effective preprocessing step before subsequent analyses, but please, please, &lt;em&gt;please&lt;/em&gt; do &lt;strong&gt;not&lt;/strong&gt; deconvolve your PSF, that just doesn&amp;rsquo;t make any sense.&lt;/p&gt;
&lt;section class=&#34;footnotes&#34; role=&#34;doc-endnotes&#34;&gt;
&lt;hr&gt;
&lt;ol&gt;
&lt;li id=&#34;fn:1&#34; role=&#34;doc-endnote&#34;&gt;
&lt;p&gt;At some point I&amp;rsquo;ll rant &lt;em&gt;ad nauseam&lt;/em&gt; about resolution and it&amp;rsquo;s definition (or lack thereof) in optical microscopy. For now let&amp;rsquo;s just say that the maximum spatial frequency a system can pass isn&amp;rsquo;t quite as important as the maximum spatial frequency &lt;em&gt;you can measure&lt;/em&gt;: a number that is completely SNR dependent. The OTF of the microscope really describes the &lt;strong&gt;best&lt;/strong&gt; case scenario which is rarely, if ever, achieved in practice. &lt;a href=&#34;#fnref:1&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&#34;fn:2&#34; role=&#34;doc-endnote&#34;&gt;
&lt;p&gt;I&amp;rsquo;m not going to name any names ü§ê. &lt;a href=&#34;#fnref:2&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&#34;fn:3&#34; role=&#34;doc-endnote&#34;&gt;
&lt;p&gt;Yeah, yeah, yeah, I can hear you complaining already, &amp;ldquo;But I just read &lt;a href=&#34;https://www.nature.com/collections/cfcdjceech&#34;&gt;these&lt;/a&gt; papers and they show that the deep learning networks &lt;em&gt;can&lt;/em&gt; improve resolution!&amp;rdquo; That&amp;rsquo;s an argument for a different day, but I&amp;rsquo;ll leave you with &lt;a href=&#34;https://www.sciencemag.org/news/2018/05/ai-researchers-allege-machine-learning-alchemy&#34;&gt;this&lt;/a&gt; for now. &lt;a href=&#34;#fnref:3&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&#34;fn:4&#34; role=&#34;doc-endnote&#34;&gt;
&lt;p&gt;Using my &lt;a href=&#34;https://github.com/david-hoffman/pyOTF&#34;&gt;&lt;code&gt;pyotf&lt;/code&gt; package&lt;/a&gt; &lt;a href=&#34;#fnref:4&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&#34;fn:5&#34; role=&#34;doc-endnote&#34;&gt;
&lt;p&gt;A standard &lt;a href=&#34;http://en.wikipedia.org/wiki/Richardson%E2%80%93Lucy_deconvolution&#34;&gt;Richardson-Lucy&lt;/a&gt; &lt;a href=&#34;https://github.com/david-hoffman/pyDecon/blob/7304674947a1efc5b00b41927ffb600ec03a2144/decon.py#L138&#34;&gt;deconvolution algorithm&lt;/a&gt; was run for 10 iterations without acceleration. Running the simulation with a &lt;a href=&#34;https://scikit-image.org/docs/dev/api/skimage.restoration.html#skimage.restoration.richardson_lucy&#34;&gt;different implementation&lt;/a&gt; yielded similar results. &lt;a href=&#34;#fnref:5&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&#34;fn:6&#34; role=&#34;doc-endnote&#34;&gt;
&lt;p&gt;If you define resolution as FWHM, which I think is wrong, then that improves as well. &lt;a href=&#34;#fnref:6&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&#34;fn:7&#34; role=&#34;doc-endnote&#34;&gt;
&lt;p&gt;Using the same Richardson-Lucy algorithm as above except with 20 iterations and linear acceleration. &lt;a href=&#34;#fnref:7&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&#34;fn:8&#34; role=&#34;doc-endnote&#34;&gt;
&lt;p&gt;More when using the radially averaged image, likely because it captures more of the aberrations of the microscope. &lt;a href=&#34;#fnref:8&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;
</description>
    </item>
    
    <item>
      <title>Nyquist Sampling SMLM</title>
      <link>https://david-hoffman.github.io/post/nyquist-sampling-smlm/</link>
      <pubDate>Thu, 16 Apr 2020 19:59:12 -0700</pubDate>
      
      <guid>https://david-hoffman.github.io/post/nyquist-sampling-smlm/</guid>
      <description>&lt;p&gt;People have been arguing over the &amp;ldquo;real&amp;rdquo; resolution of &lt;a href=&#34;https://en.wikipedia.org/wiki/Super-resolution_microscopy#Localization_microscopy&#34;&gt;single molecule localization microscopy&lt;/a&gt; (&lt;a href=&#34;https://www.microscopyu.com/techniques/super-resolution/single-molecule-super-resolution-imaging&#34;&gt;SMLM&lt;/a&gt;) since it&amp;rsquo;s inception&lt;sup id=&#34;fnref:1&#34;&gt;&lt;a href=&#34;#fn:1&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;1&lt;/a&gt;&lt;/sup&gt; (see the many references in Legant et al.&lt;sup id=&#34;fnref:2&#34;&gt;&lt;a href=&#34;#fn:2&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;2&lt;/a&gt;&lt;/sup&gt;). New comers are often wowed by the insanely small localization &lt;em&gt;precisions&lt;/em&gt; achievable with modern SMLM microscopes and dyes which can routinely drop below 10 nm (a factor of nearly 20 fold below the diffraction limit ü§Ø). However, it is clear to &amp;ldquo;those skilled in the art&amp;rdquo; that this merely represents the lower bound for the &lt;em&gt;actual resolution&lt;/em&gt; of one&amp;rsquo;s image.&lt;/p&gt;
&lt;p&gt;Early on in the debate, many made frequent appeals to the concept of &lt;a href=&#34;https://en.wikipedia.org/wiki/Nyquist%E2%80%93Shannon_sampling_theorem&#34;&gt;Nyquist sampling&lt;/a&gt; which simply states that you must sample at twice the highest frequency you&amp;rsquo;re hoping to measure. Because images are made up of &lt;em&gt;spatial&lt;/em&gt; frequencies the argument is that you need a localization &lt;em&gt;density&lt;/em&gt; of at least twice the highest frequency you&amp;rsquo;re trying to measure. For instance, let&amp;rsquo;s say you wanted to measure &lt;a href=&#34;https://en.wikipedia.org/wiki/Endoplasmic_reticulum&#34;&gt;ER&lt;/a&gt; tubules of approximately 50 nm in diameter then you&amp;rsquo;d need at least one localization every 25 nm or 40 localizations every micron &amp;mdash; &lt;em&gt;in a single dimension&lt;/em&gt;! If you&amp;rsquo;d like to measure such a structure in 3D then you&amp;rsquo;d need &lt;em&gt;64,000 molecules per cubic micron&lt;/em&gt;! That means you&amp;rsquo;ll need millions or even billions&lt;sup id=&#34;fnref:2&#34;&gt;&lt;a href=&#34;#fn:2&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;2&lt;/a&gt;&lt;/sup&gt; of localizations to achieve the resolution you want.&lt;/p&gt;
&lt;p&gt;Unfortunately, the argument laid out above is really a best case scenario and even if you achieved such a high localization rate your signal to noise ratio (SNR) would be 1. To understand why, consider the simple model shown in Fig. 1 below. Here our sample is a one dimensional square wave of period $L$ (wavelength) and height $S$ (signal) offset by an amount $B$ (background). The background is representative of non-specific labeling or junk during imaging.&lt;/p&gt;






&lt;figure&gt;

  &lt;a data-fancybox=&#34;&#34; href=&#34;1D%20Model.png&#34; &gt;

&lt;img src=&#34;1D%20Model.png&#34; &gt;
&lt;/a&gt;


&lt;figcaption data-pre=&#34;Figure &#34; data-post=&#34;:&#34; class=&#34;numbered&#34;&gt;
  &lt;h4&gt;A square wave of period (wavelength) $L$ shown as the thick orange line. The dashed orange line is the background component of intensity $B$ and the green solid line is the signal component of intensity $S$&lt;/h4&gt;
  
&lt;/figcaption&gt;

&lt;/figure&gt;

&lt;p&gt;A simple argument would lead you to believe that you want a single molecule localized per period meaning that our desired labeling density is $\rho = 1 / L$. But this doesn&amp;rsquo;t take into account any noise sources. It&amp;rsquo;s reasonable to assume that protein production, labeling, and imaging (i.e. detection, localization, etc.) all lead to roughly &lt;a href=&#34;https://en.wikipedia.org/wiki/Poisson_distribution&#34;&gt;Poisson statistics&lt;/a&gt; for localization density. A Poisson distribution has a well defined variance, namely $\sigma^2 = \mu$ where $\mu$ is the mean value, thus the standard deviation is $\sigma = \sqrt{\mu}$. In the case of one localization per period that means you have an SNR of &lt;strong&gt;1&lt;/strong&gt; üò±.&lt;sup id=&#34;fnref:3&#34;&gt;&lt;a href=&#34;#fn:3&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;3&lt;/a&gt;&lt;/sup&gt; If you wanted to have an SNR of 2 you&amp;rsquo;d need 4 localizations, on average, per period. Referring back to our example of ER tubules above this translates to &lt;strong&gt;4 million localizations per cubic micron&lt;/strong&gt;.&lt;sup id=&#34;fnref:4&#34;&gt;&lt;a href=&#34;#fn:4&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;4&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;
&lt;p&gt;Including background noise isn&amp;rsquo;t much harder. Assuming the background is also Poisson distributed we can use the &lt;a href=&#34;https://en.wikipedia.org/wiki/Skellam_distribution&#34;&gt;Skellam distribution&lt;/a&gt; setting $\mu_1 = S + B$ and $\mu_2 = B$ which gives an SNR of&lt;/p&gt;
&lt;p&gt;$$
SNR = \frac{\mu_1 - \mu_2}{\sqrt{\mu_1 + \mu_2}} = \frac{S}{\sqrt{S + 2B}}
$$&lt;/p&gt;
&lt;p&gt;We can rearrange the above equation, setting $S$ equal to the number of localized molecules per period $N$, to read&lt;/p&gt;
&lt;p&gt;$$
N = \frac{SNR^2}{2}\left(1 + \sqrt{1 + \frac{8 B}{SNR^2}}\right)
$$&lt;/p&gt;
&lt;p&gt;For example, if you want and SNR of 3 and your background is 2 molecules, on average, then you&amp;rsquo;d need an average of 12 molecules per period. Again, going back to the ER example that means you&amp;rsquo;d need &lt;strong&gt;111 million localizations per cubic micron&lt;/strong&gt;.&lt;sup id=&#34;fnref:5&#34;&gt;&lt;a href=&#34;#fn:5&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;5&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;
&lt;p&gt;We can compare this analytical formula to the simulations of Legant et al.&lt;sup id=&#34;fnref:2&#34;&gt;&lt;a href=&#34;#fn:2&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;2&lt;/a&gt;&lt;/sup&gt; (&lt;a href=&#34;https://static-content.springer.com/esm/art%3A10.1038%2Fnmeth.3797/MediaObjects/41592_2016_BFnmeth3797_MOESM225_ESM.pdf&#34;&gt;see supplemental figures 1 and 3 therein&lt;/a&gt;). In that publication a sinusoidal pattern was used but we can normalize the two by averaging the sinusoid&amp;rsquo;s intensity over half periods and using the resulting peak-to-peak intensity as our $S$. For a sinusoid of amplitude $A$ (i.e. $y(x) = A \sin x$) The integrated amplitude is $2 A /\pi$. Therefore our normalization factor is $\pi / 4$.&lt;/p&gt;
&lt;p&gt;For SI figure 1 we have the following analytical SNRs:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;0.89&lt;/li&gt;
&lt;li&gt;1.25&lt;/li&gt;
&lt;li&gt;1.99&lt;/li&gt;
&lt;li&gt;2.8&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;For SI figure 3 we have the following analytical SNRs:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1.31&lt;/li&gt;
&lt;li&gt;1.05&lt;/li&gt;
&lt;li&gt;1.86&lt;/li&gt;
&lt;li&gt;1.49&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;conclusion&#34;&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;Getting really good &lt;strong&gt;real&lt;/strong&gt; resolution in SMLM (i.e. anything below ~50 nm average in $x$, $y$, and $z$) is really hard and requires minimal background and really really good labeling density.&lt;sup id=&#34;fnref:6&#34;&gt;&lt;a href=&#34;#fn:6&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;6&lt;/a&gt;&lt;/sup&gt; One saving grace is that this argument assumes you have &lt;em&gt;absolutely &lt;strong&gt;no&lt;/strong&gt; prior knowledge&lt;/em&gt; about the structure you&amp;rsquo;re imaging. Take for example Fig 2. below. It doesn&amp;rsquo;t take a whole lot of points before it becomes obvious we&amp;rsquo;re imaging a circle. It takes many more points to get an accurate measure of the width of the circle. But once you&amp;rsquo;re fairly confident that it&amp;rsquo;s a circle you can perform a radial average to determine the width; this type of methodology has been used to great effect before.&lt;sup id=&#34;fnref:7&#34;&gt;&lt;a href=&#34;#fn:7&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;7&lt;/a&gt;&lt;/sup&gt; In short, the resolution of your image is &lt;em&gt;not&lt;/em&gt; equivalent to your localization precision and resolution, in the traditional sense, may not even be relevant to what you&amp;rsquo;re trying to measure.&lt;/p&gt;






&lt;figure&gt;

  &lt;a data-fancybox=&#34;&#34; href=&#34;featured.png&#34; &gt;

&lt;img src=&#34;featured.png&#34; &gt;
&lt;/a&gt;


&lt;figcaption data-pre=&#34;Figure &#34; data-post=&#34;:&#34; class=&#34;numbered&#34;&gt;
  &lt;h4&gt;Randomly sampling points on a circle.&lt;/h4&gt;
  
&lt;/figcaption&gt;

&lt;/figure&gt;

&lt;section class=&#34;footnotes&#34; role=&#34;doc-endnotes&#34;&gt;
&lt;hr&gt;
&lt;ol&gt;
&lt;li id=&#34;fn:1&#34; role=&#34;doc-endnote&#34;&gt;
&lt;p&gt;&lt;a href=&#34;http://www.sciencemag.org/content/313/5793/1642&#34;&gt;E. Betzig, G. H. Patterson, R. Sougrat, O. W. Lindwasser, S. Olenych, J. S. Bonifacino, M. W. Davidson, J. Lippincott-Schwartz, H. F. Hess, Imaging Intracellular Fluorescent Proteins at Nanometer Resolution. Science. 313, 1642‚Äì1645 (2006).&lt;/a&gt; &lt;a href=&#34;#fnref:1&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&#34;fn:2&#34; role=&#34;doc-endnote&#34;&gt;
&lt;p&gt;&lt;a href=&#34;https://www.nature.com/articles/nmeth.3797&#34;&gt;W. R. Legant, L. Shao, J. B. Grimm, T. A. Brown, D. E. Milkie, B. B. Avants, L. D. Lavis, E. Betzig, High-density three-dimensional localization microscopy across large volumes. Nat Meth. 13, 359‚Äì365 (2016)&lt;/a&gt; &lt;a href=&#34;#fnref:2&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&#34;fn:3&#34; role=&#34;doc-endnote&#34;&gt;
&lt;p&gt;Noting that $SNR = \mu/\sigma$. PS: I personally would never try to make a scientific argument based on data with an SNR of 1. &lt;a href=&#34;#fnref:3&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&#34;fn:4&#34; role=&#34;doc-endnote&#34;&gt;
&lt;p&gt;Remember this would be 4M / ¬µm$^3$ &lt;em&gt;only&lt;/em&gt; for the actual ER tubule. Considering that the mean diameter of a tubule is 50 nm this equates to roughly 8k molecules per micron of tubule. &lt;a href=&#34;#fnref:4&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&#34;fn:5&#34; role=&#34;doc-endnote&#34;&gt;
&lt;p&gt;This equates to roughly 220k molecules per micron of tubule. Also, 1 cubic micron is roughly 500 linear microns of ER tubule üòÖ. &lt;a href=&#34;#fnref:5&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&#34;fn:6&#34; role=&#34;doc-endnote&#34;&gt;
&lt;p&gt;One of the reasons regular &lt;a href=&#34;https://en.wikipedia.org/wiki/Electron_microscope&#34;&gt;EM&lt;/a&gt; is so damn good is due to the fact that the labeling density (e.g. &lt;a href=&#34;https://en.wikipedia.org/wiki/Staining#Electron_microscopy&#34;&gt;osmium staining&lt;/a&gt;) is so high. Even if you could build an optical microscope with the resolution of an electron microscope you&amp;rsquo;d never get to take advantage of it. &lt;a href=&#34;#fnref:6&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&#34;fn:7&#34; role=&#34;doc-endnote&#34;&gt;
&lt;p&gt;&lt;a href=&#34;http://science.sciencemag.org/content/341/6146/655&#34;&gt;A. Szymborska, A. de Marco, N. Daigle, V. C. Cordes, J. A. G. Briggs, J. Ellenberg, Nuclear Pore Scaffold Structure Analyzed by Super-Resolution Microscopy and Particle Averaging. Science. 341, 655‚Äì658 (2013).&lt;/a&gt; &lt;a href=&#34;#fnref:7&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;
</description>
    </item>
    
    <item>
      <title>Oh no, I squished my OTF!</title>
      <link>https://david-hoffman.github.io/post/otf-squishing/</link>
      <pubDate>Sat, 11 Apr 2020 00:00:00 +0000</pubDate>
      
      <guid>https://david-hoffman.github.io/post/otf-squishing/</guid>
      <description>&lt;h2 id=&#34;a-question-of-index&#34;&gt;A question of index&lt;/h2&gt;
&lt;p&gt;Something I learned the hard way during my post-doc is the effect index mismatching can have on images taken with high NA air objectives (in my case a Nikon CFI L Plan EPI CRB 100X 0.85 NA lens). Many&lt;sup id=&#34;fnref:1&#34;&gt;&lt;a href=&#34;#fn:1&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;1&lt;/a&gt;&lt;/sup&gt; previous&lt;sup id=&#34;fnref:2&#34;&gt;&lt;a href=&#34;#fn:2&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;2&lt;/a&gt;&lt;/sup&gt; authors&lt;sup id=&#34;fnref:3&#34;&gt;&lt;a href=&#34;#fn:3&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;3&lt;/a&gt;&lt;/sup&gt; have commented on and analyzed degradation of image quality when the index for which an objective is designed does not match the one in which it is used. Even so, many users of optical microscopes remain unaware of this issue. The problems induced by index mismatch can be summarized as follows (where $n_{obj}$ is the design index and $n_{sample}$ is the mounting index):&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;NA is reduced to the index of the specimen, i.e. $NA = n_{sample}$, when $n_{obj} &amp;gt; n_{sample}$&lt;/li&gt;
&lt;li&gt;Compression of the image when $n_{obj} &amp;lt; n_{sample}$ and a concomitant reduction in expected axial resolution&lt;/li&gt;
&lt;li&gt;Increasing spherical aberration as the objective&amp;rsquo;s focus is moved deeper into the sample when $n_{obj} \neq n_{sample}$&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;To explain the first problem imagine we are imaging a point source radiating spherical waves of light embedded in a medium of index $n_{sample}$ near the interface with a medium of index $n_{obj}$ (c.f. Figure 1). After a certain axial distance the spherical wave encounters the interface and refracts. Appealing to geometrical optical arguments we say that only the bottom hemisphere of light can be captured. The maximum angle of rays that can be captured are rays that propagate along the interface (i.e. at an angle of 90¬∞ relative to the interface normal) and these are refracted at an angle &lt;a href=&#34;https://en.wikipedia.org/wiki/Total_internal_reflection#Critical_angle&#34;&gt;$\theta_c = \arcsin(n_{sample}/n_{obj})$&lt;/a&gt;. According to &lt;a href=&#34;https://en.wikipedia.org/wiki/Snell%27s_law&#34;&gt;Snell&amp;rsquo;s law&lt;/a&gt; and the definition for &lt;a href=&#34;https://en.wikipedia.org/wiki/Numerical_aperture&#34;&gt;NA&lt;/a&gt; this means that the maximum possible NA for this configuration is $NA = n_{obj} \sin(\theta_c) = n_{sample} \sin(\pi/2) = n_{sample}$&lt;/p&gt;






&lt;figure&gt;

  &lt;a data-fancybox=&#34;&#34; href=&#34;TIRF_Diagram.png&#34; &gt;

&lt;img src=&#34;TIRF_Diagram.png&#34; &gt;
&lt;/a&gt;


&lt;figcaption data-pre=&#34;Figure &#34; data-post=&#34;:&#34; class=&#34;numbered&#34;&gt;
  &lt;h4&gt;A point source emitting from a lower index material to a higher index material&lt;/h4&gt;
  
&lt;/figcaption&gt;

&lt;/figure&gt;

&lt;p&gt;The second problem, when $n_{obj} &amp;lt; n_{sample}$, is trickier and I covered it in some detail in the &lt;a href=&#34;http://science.sciencemag.org/content/367/6475/eaaz5357/suppl/DC1&#34;&gt;supplemental material&lt;/a&gt; of our &lt;a href=&#34;https://science.sciencemag.org/content/367/6475/eaaz5357&#34;&gt;cryo paper&lt;/a&gt;. Looking at the OTF support in the $k_xk_z$ plane, as shown in Figure 2, we can see that the OTF gets &amp;ldquo;squished&amp;rdquo; in the $k_z$ direction. A key insight is that while the lateral resolution is independent of index due to Snell&amp;rsquo;s law, $NA = n_{obj}\sin(\theta_{obj}) = n_{sample}\sin(\theta_{sample})$, the axial resolution is not.&lt;sup id=&#34;fnref:4&#34;&gt;&lt;a href=&#34;#fn:4&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;4&lt;/a&gt;&lt;/sup&gt; Axial resolution (sometimes termed &lt;a href=&#34;https://en.wikipedia.org/wiki/Depth_of_field&#34;&gt;depth of field&lt;/a&gt; or depth of focus) for high NA systems has been derived before&lt;sup id=&#34;fnref:5&#34;&gt;&lt;a href=&#34;#fn:5&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;5&lt;/a&gt;&lt;/sup&gt; and can be modified for differing indices of refraction to be&lt;/p&gt;
&lt;p&gt;$$
\Delta z = \frac{\lambda}{n_{sample} - \sqrt{n_{sample}^2 - NA^2}}
$$&lt;/p&gt;
&lt;p&gt;and herein lies the observed squishing effect&lt;sup id=&#34;fnref:6&#34;&gt;&lt;a href=&#34;#fn:6&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;6&lt;/a&gt;&lt;/sup&gt;: as $n_{sample}$ increases relative to $NA$ the denominator decreases and $\Delta z$ increases.&lt;/p&gt;






&lt;figure&gt;

  &lt;a data-fancybox=&#34;&#34; href=&#34;featured.png&#34; &gt;

&lt;img src=&#34;featured.png&#34; &gt;
&lt;/a&gt;


&lt;figcaption data-pre=&#34;Figure &#34; data-post=&#34;:&#34; class=&#34;numbered&#34;&gt;
  &lt;h4&gt;OTF support for fixed NA and variable index of refraction ($n$), specifically comparing air ($n=1$) to vitreous ice ($n=1.3$)&lt;/h4&gt;
  
&lt;/figcaption&gt;

&lt;/figure&gt;

&lt;p&gt;Investigating the third problem will require real math based on the work of T√∂r√∂k&lt;sup id=&#34;fnref:1&#34;&gt;&lt;a href=&#34;#fn:1&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;1&lt;/a&gt;&lt;/sup&gt;, T√∂r√∂k&lt;sup id=&#34;fnref:2&#34;&gt;&lt;a href=&#34;#fn:2&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;2&lt;/a&gt;&lt;/sup&gt;, and Egner.&lt;sup id=&#34;fnref:3&#34;&gt;&lt;a href=&#34;#fn:3&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;3&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;
&lt;h2 id=&#34;focal-plane-displacement-in-mismatched-media-a-vectorial-calculation&#34;&gt;Focal plane displacement in mismatched media, a Vectorial Calculation&lt;/h2&gt;
&lt;p&gt;I&amp;rsquo;ll be following the notation of Egner&lt;sup id=&#34;fnref:3&#34;&gt;&lt;a href=&#34;#fn:3&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;3&lt;/a&gt;&lt;/sup&gt;. Equation 9 gives the vectorial point spread function in terms of three diffraction integrals. Note that for on axis light ($x=0$ and $y=0$) the integrands of $I_1(\vec{r})$ and  $I_2(\vec{r})$ are $0$ and $I_0(\vec{r})$ reduces to&lt;/p&gt;
&lt;p&gt;$$
I_0(z) = \int_0^\alpha \sqrt{\cos(\theta_1)}\sin(\theta_1)(\tau_s+\tau_p \cos(\theta_2))\exp(ik(\Phi(NFP)+n_2z\cos(\theta_2)))d\theta_1
$$&lt;/p&gt;
&lt;p&gt;Where&lt;/p&gt;
&lt;p&gt;$$
\Phi(NFP) = -NFP(n_1\cos\theta_1-n_2\cos\theta_2)
$$&lt;/p&gt;
&lt;p&gt;$k$ is the wavenumber of the light rays &lt;em&gt;in vacuo&lt;/em&gt;, i.e. $k = 2\pi/\lambda$. $\alpha$ is the aperture semi-angle of the lens, i.e. $\text{NA}=n_1 \sin\alpha$. Note that $n_1 = n_{obj}$ and $n_2 = n_{sample}$.&lt;/p&gt;
&lt;p&gt;We can now implement these functions in Python.&lt;/p&gt;
&lt;h2 id=&#34;python-time&#34;&gt;Python time&lt;/h2&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt;pylab inline
&lt;span style=&#34;color:#f92672&#34;&gt;import&lt;/span&gt; scipy.integrate
&lt;span style=&#34;color:#f92672&#34;&gt;import&lt;/span&gt; scipy.optimize

&lt;span style=&#34;color:#f92672&#34;&gt;import&lt;/span&gt; seaborn &lt;span style=&#34;color:#f92672&#34;&gt;as&lt;/span&gt; sns

sns&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;set()
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;complex_quadrature&lt;/span&gt;(func, a, b, &lt;span style=&#34;color:#f92672&#34;&gt;**&lt;/span&gt;kwargs):
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&amp;#34;&amp;#34;scipy.integrate.quad doesn&amp;#39;t deal with complex numbers, so this hack does&amp;#34;&amp;#34;&amp;#34;&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;real_func&lt;/span&gt;(x):
        &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; real(func(x))
    &lt;span style=&#34;color:#66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;imag_func&lt;/span&gt;(x):
        &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; imag(func(x))
    real_integral &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; scipy&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;integrate&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;quad(real_func, a, b, &lt;span style=&#34;color:#f92672&#34;&gt;**&lt;/span&gt;kwargs)
    imag_integral &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; scipy&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;integrate&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;quad(imag_func, a, b, &lt;span style=&#34;color:#f92672&#34;&gt;**&lt;/span&gt;kwargs)
    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; (real_integral[&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1j&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;imag_integral[&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;], real_integral[&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;:], imag_integral[&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;:])

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;@vectorize&lt;/span&gt;
&lt;span style=&#34;color:#66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;i0&lt;/span&gt;(z, NFP, n1, n2, NA, wl):
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&amp;#34;&amp;#34;This calculates e-field amplitude _relative to_ NFP, only along the z axis with x, y = 0, 0&amp;#34;&amp;#34;&amp;#34;&lt;/span&gt;
    theta_max &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; arcsin(NA &lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt; n1)
    
    &lt;span style=&#34;color:#66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;integrand&lt;/span&gt;(theta1):
        sin_t1 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; sin(theta1)
        theta2 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; arcsin(n1 &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; sin_t1 &lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt; n2)
        sin_t2 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; sin(theta2)
        cos_t1 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; cos(theta1)
        cos_t2 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; cos(theta2)
        ts &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; sin_t2 &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; cos_t1 &lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt; sin(theta1 &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; theta2)
        tp &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; ts &lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt; cos(theta1 &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; theta2)
        
        k &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; pi &lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt; wl
        phi &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;NFP &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; (n1 &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; cos_t1 &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; n2 &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; cos_t2)
        &lt;span style=&#34;color:#75715e&#34;&gt;# make sure i is complex&lt;/span&gt;
        i &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; exp(&lt;span style=&#34;color:#ae81ff&#34;&gt;1j&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; k &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; (phi &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; n2 &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; z &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; cos_t2))
        i &lt;span style=&#34;color:#f92672&#34;&gt;*=&lt;/span&gt; sqrt(cos_t1) &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; sin_t1 &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; (ts &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; tp &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; cos_t2)
        &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; i
        
    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; complex_quadrature(integrand, &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, theta_max)[&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;]
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;A short test to see if the calculation works using the example from Egner and Hell a 1.518 oil objective 1.47 NA&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;z &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; np&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;linspace(&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;128&lt;/span&gt;)
a_exc &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; i0(z, &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;15&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;1.518&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;1.47&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;1.33&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0.514&lt;/span&gt;)
a_em &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; i0(z, &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;15&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;1.518&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;1.47&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;1.33&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0.59&lt;/span&gt;)

fig, ax &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; plt&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;subplots(dpi&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;150&lt;/span&gt;)
ax&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;plot(z, abs(a_exc)&lt;span style=&#34;color:#f92672&#34;&gt;**&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, label&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Excitation PSF&amp;#34;&lt;/span&gt;)
ax&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;plot(z, abs(a_em)&lt;span style=&#34;color:#f92672&#34;&gt;**&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, label&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Emission PSF&amp;#34;&lt;/span&gt;)
ax&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;plot(z, abs(a_exc)&lt;span style=&#34;color:#f92672&#34;&gt;**&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; abs(a_em)&lt;span style=&#34;color:#f92672&#34;&gt;**&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, label&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Confocal PSF&amp;#34;&lt;/span&gt;)
ax&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;legend()
ax&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;yaxis&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;set_major_locator(plt&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;NullLocator())
ax&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;set_xlabel(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Axial Position (¬µm)&amp;#34;&lt;/span&gt;)
ax&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;set_title(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Computation Test, Oil Objective&amp;#34;&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;output_4_1.png&#34; alt=&#34;png&#34;&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# we need an esimate of the focal shift in order to reduce computation time&lt;/span&gt;
&lt;span style=&#34;color:#66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;otf_ratio&lt;/span&gt;(n1, n2, NA):
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&amp;#34;&amp;#34;The OTF ratio as calculated from the geometrical proof&amp;#34;&amp;#34;&amp;#34;&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;func&lt;/span&gt;(n):
        &lt;span style=&#34;color:#75715e&#34;&gt;# fmax takes care of limiting NA&lt;/span&gt;
        &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; n &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; sqrt(np&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;fmax(&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, n&lt;span style=&#34;color:#f92672&#34;&gt;**&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; NA&lt;span style=&#34;color:#f92672&#34;&gt;**&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;))
    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; func(n1) &lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt; func(n2)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;_find_afp&lt;/span&gt;(NFP, n1, n2, NA, wl_ex, wl_em&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;None, &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;, res&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;32&lt;/span&gt;, width&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;5&lt;/span&gt;, ax&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;None):
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&amp;#34;&amp;#34;Find the _apparent_ focal position based on the nominal focal position&amp;#34;&amp;#34;&amp;#34;&lt;/span&gt;
    
    &lt;span style=&#34;color:#75715e&#34;&gt;# if no emission wavelength is given, then calculate the widefield PSF&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; wl_em &lt;span style=&#34;color:#f92672&#34;&gt;is&lt;/span&gt; None:
        &lt;span style=&#34;color:#66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;i0_min&lt;/span&gt;(z):
            &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;abs(i0(z, NFP, n1, n2, NA, wl_ex))&lt;span style=&#34;color:#f92672&#34;&gt;**&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;
    &lt;span style=&#34;color:#75715e&#34;&gt;# otherwise calculate the confocal PSF&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;else&lt;/span&gt;:
        &lt;span style=&#34;color:#66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;i0_min&lt;/span&gt;(z):
            toreturn &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;abs(i0(z, NFP, n1, n2, NA, wl_ex))&lt;span style=&#34;color:#f92672&#34;&gt;**&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt; 
            &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; toreturn &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; abs(i0(z, NFP, n1, n2, NA, wl_em))&lt;span style=&#34;color:#f92672&#34;&gt;**&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;
        
    &lt;span style=&#34;color:#75715e&#34;&gt;# calculate the approximate focal shift, so the optimization is close to the optimum&lt;/span&gt;
    focal_shift &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; otf_ratio(n1, n2, NA)
    
    &lt;span style=&#34;color:#75715e&#34;&gt;# make a rough low res estimate relative to the estimated focal shift&lt;/span&gt;
    low_res_z &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; np&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;linspace(&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;width, width, res) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; NFP &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; (focal_shift &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;)
    low_res_a &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;i0_min(low_res_z)
    low_res_max_idx &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; low_res_a&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;argmax()
    
    &lt;span style=&#34;color:#75715e&#34;&gt;# optimize to find the proper location of the optimum&lt;/span&gt;
    high_res_max &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; scipy&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;optimize&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;minimize_scalar(i0_min, bounds&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;(low_res_z[low_res_max_idx &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;], low_res_z[low_res_max_idx &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;]), method&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;bounded&amp;#39;&lt;/span&gt;, options&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;dict(xatol&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1e-10&lt;/span&gt;))
    
    &lt;span style=&#34;color:#75715e&#34;&gt;# looks like we failed to find a maximum&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;not&lt;/span&gt; high_res_max&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;success:
        &lt;span style=&#34;color:#66d9ef&#34;&gt;raise&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;RuntimeError&lt;/span&gt;(high_res_max&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;message)
    
    &lt;span style=&#34;color:#75715e&#34;&gt;# make a plot&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; ax &lt;span style=&#34;color:#f92672&#34;&gt;is&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;not&lt;/span&gt; None:
        ax&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;plot(low_res_z, low_res_a)
        ax&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;axvline(high_res_max&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;x, c&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;r&amp;#34;&lt;/span&gt;)
    
    
    max_intensity &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;high_res_max&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;fun
    
    &lt;span style=&#34;color:#75715e&#34;&gt;# return the shifted AFP&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; high_res_max&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;x &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; NFP, max_intensity


&lt;span style=&#34;color:#66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;find_afp&lt;/span&gt;(NFP, &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;args, &lt;span style=&#34;color:#f92672&#34;&gt;**&lt;/span&gt;kwargs):
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&amp;#34;&amp;#34;A simple version to vectorize over z, for convenience&amp;#34;&amp;#34;&amp;#34;&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;try&lt;/span&gt;:
        &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; np&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;array([_find_afp(z, &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;args, &lt;span style=&#34;color:#f92672&#34;&gt;**&lt;/span&gt;kwargs) &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; z &lt;span style=&#34;color:#f92672&#34;&gt;in&lt;/span&gt; NFP])
    &lt;span style=&#34;color:#66d9ef&#34;&gt;except&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;TypeError&lt;/span&gt;:
        &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; _find_afp(NFP, &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;args, &lt;span style=&#34;color:#f92672&#34;&gt;**&lt;/span&gt;kwargs)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;testing&#34;&gt;Testing&lt;/h3&gt;
&lt;p&gt;On page 409 of Egner&lt;sup id=&#34;fnref:3&#34;&gt;&lt;a href=&#34;#fn:3&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;3&lt;/a&gt;&lt;/sup&gt; there are some example calculations that we can repeat to test the validity of the calculations.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;with&lt;/span&gt; sns&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;color_palette(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;inferno&amp;#34;&lt;/span&gt;):
    &lt;span style=&#34;color:#75715e&#34;&gt;# our confocal calculations&lt;/span&gt;
    fig, ax &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; plt&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;subplots(dpi&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;150&lt;/span&gt;)
    
    nfps &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;5&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;10&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;15&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;20&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;25&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;30&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;50&lt;/span&gt;) 
    glycerol_cf &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; find_afp(
        nfps,
        &lt;span style=&#34;color:#ae81ff&#34;&gt;1.518&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;1.473&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;1.3&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0.514&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0.59&lt;/span&gt;,
        res&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;128&lt;/span&gt;, width&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, ax&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;ax
    )

    &lt;span style=&#34;color:#75715e&#34;&gt;# values taken from table 20.1 of Egner and Hell&lt;/span&gt;
    glycerol_lit &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; np&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;array((
        (&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0.28&lt;/span&gt;, &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0.55&lt;/span&gt;, &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0.83&lt;/span&gt;, &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1.1&lt;/span&gt;, &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1.33&lt;/span&gt;, &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1.54&lt;/span&gt;, &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2.30&lt;/span&gt;),
        (&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0.95&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0.91&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0.78&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0.62&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0.5&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0.4&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0.31&lt;/span&gt;)
    ))&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;T

    &lt;span style=&#34;color:#75715e&#34;&gt;# percent differences between our calculations and theirs for focal shift&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;print&lt;/span&gt;((glycerol_lit[:, &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; (glycerol_cf[:, &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;5&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;10&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;15&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;20&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;25&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;30&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;50&lt;/span&gt;))) &lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt; glycerol_lit[:, &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;100&lt;/span&gt;)

    &lt;span style=&#34;color:#75715e&#34;&gt;# percent differences between our calculations and theirs for peak intensity&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;print&lt;/span&gt;((glycerol_lit[:, &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; glycerol_cf[:, &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt; glycerol_cf[:, &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;max()) &lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt; glycerol_lit[:, &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;100&lt;/span&gt;)

    ax&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;yaxis&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;set_major_locator(plt&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;NullLocator())
    ax&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;set_xlabel(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Deviation from Nominal Focal Position (¬µm)&amp;#34;&lt;/span&gt;)
    &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; line &lt;span style=&#34;color:#f92672&#34;&gt;in&lt;/span&gt; ax&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;get_lines():
        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; len(line&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;get_data()[&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;]) &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;:
            line&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;remove()

    ax&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;set_title(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Computation Test, Oil Objective in Glycerol&amp;#34;&lt;/span&gt;)
    ax&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;legend(nfps, title&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;NFP (¬µm)&amp;#34;&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;[        inf  2.2220463   0.62956575  1.5641702   1.51523215 -0.91086836
 -2.9878027   2.47268137]
[ 0.         -2.05250791  2.91190777  2.94368608  1.49427111  6.83299954
 14.99787706 39.09604286]
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;output_8_2.png&#34; alt=&#34;png&#34;&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;with&lt;/span&gt; sns&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;color_palette(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;inferno&amp;#34;&lt;/span&gt;):
    &lt;span style=&#34;color:#75715e&#34;&gt;# our confocal calculations&lt;/span&gt;
    fig, ax &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; plt&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;subplots(dpi&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;150&lt;/span&gt;)

    nfps &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;5&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;10&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;15&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;20&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;25&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;30&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;50&lt;/span&gt;)
    water_cf &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; find_afp(
        nfps,
        &lt;span style=&#34;color:#ae81ff&#34;&gt;1.33&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;1.473&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;1.3&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0.514&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0.59&lt;/span&gt;,
        res&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;256&lt;/span&gt;, width&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;15&lt;/span&gt;, ax&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;ax
    )

    &lt;span style=&#34;color:#75715e&#34;&gt;# values taken from table 20.1 of Egner and Hell&lt;/span&gt;
    water_lit &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; np&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;array((
        (&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1.0&lt;/span&gt;, &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1.83&lt;/span&gt;, &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2.57&lt;/span&gt;, &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;3.3&lt;/span&gt;, &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;4.02&lt;/span&gt;, &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;4.72&lt;/span&gt;, &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;7.57&lt;/span&gt;),
        (&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0.60&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0.39&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0.285&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0.23&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0.19&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0.166&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0.11&lt;/span&gt;)
    ))&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;T

    &lt;span style=&#34;color:#75715e&#34;&gt;# percent differences between our calculations and theirs for focal shift&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;print&lt;/span&gt;((water_lit[:, &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; (water_cf[:, &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;5&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;10&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;15&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;20&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;25&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;30&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;50&lt;/span&gt;))) &lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt; water_lit[:, &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;100&lt;/span&gt;)

    &lt;span style=&#34;color:#75715e&#34;&gt;# percent differences between our calculations and theirs for peak intensity&lt;/span&gt;
    &lt;span style=&#34;color:#66d9ef&#34;&gt;print&lt;/span&gt;((water_lit[:, &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; water_cf[:, &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt; water_cf[:, &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;max()) &lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt; water_lit[:, &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;100&lt;/span&gt;)

    ax&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;yaxis&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;set_major_locator(plt&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;NullLocator())
    ax&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;set_xlabel(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Deviation from Nominal Focal Position (¬µm)&amp;#34;&lt;/span&gt;)
    &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; line &lt;span style=&#34;color:#f92672&#34;&gt;in&lt;/span&gt; ax&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;get_lines():
        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; len(line&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;get_data()[&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;]) &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;:
            line&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;remove()

    ax&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;set_xlim(&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;5&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;15&lt;/span&gt;)

    ax&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;set_title(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Computation Test, Oil Objective in Water&amp;#34;&lt;/span&gt;)
    ax&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;legend(nfps, title&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;NFP (¬µm)&amp;#34;&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;[        inf -3.89876815 -1.16698752  0.24182932  1.60682485  2.02297875
  3.0281091   5.03027355]
[ 0.         48.28097585 59.70939519 65.5089603  70.36385208 72.25077729
 75.80157613 81.9156686 ]
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;output_9_2.png&#34; alt=&#34;png&#34;&gt;&lt;/p&gt;
&lt;p&gt;Our simulations match the reported focal length shift to a few percent. However, there is larger error between the our intensity and theirs.&lt;/p&gt;
&lt;h2 id=&#34;simulations-for-the-cryo-scope&#34;&gt;Simulations for the Cryo-scope&lt;/h2&gt;
&lt;p&gt;Here the objective is a 0.85 NA air objective and the sample medium is vitreous ice so $n_1=1$ and $n_2=1.3$.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;with&lt;/span&gt; sns&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;color_palette(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;inferno&amp;#34;&lt;/span&gt;):
    fig, ax &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; plt&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;subplots(dpi&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;300&lt;/span&gt;)
    
    nfps &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; (&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;8&lt;/span&gt;, &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;8&lt;/span&gt;)
    find_afp(nfps, &lt;span style=&#34;color:#ae81ff&#34;&gt;1.0&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;1.3&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0.85&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0.52&lt;/span&gt;, res&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;128&lt;/span&gt;, ax&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;ax)

    ax&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;yaxis&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;set_major_locator(plt&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;NullLocator())
    ax&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;set_xlabel(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Deviation from Nominal Focal Position (¬µm)&amp;#34;&lt;/span&gt;)
    &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; line &lt;span style=&#34;color:#f92672&#34;&gt;in&lt;/span&gt; ax&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;get_lines():
        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; len(line&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;get_data()[&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;]) &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;:
            line&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;remove()

    ax&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;set_title(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Computation Test, Air Objective in Ice&amp;#34;&lt;/span&gt;)
    ax&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;legend(nfps, title&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;NFP (¬µm)&amp;#34;&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;output_12_0.png&#34; alt=&#34;png&#34;&gt;&lt;/p&gt;
&lt;p&gt;Clearly, spherical aberrations start to become problematic when you&amp;rsquo;re more than 10 ¬µm from the best focal position (and this effect is worse the larger the mismatch between refractive indices).&lt;/p&gt;
&lt;p&gt;One question we can ask is: how well does our geometric argument fare against the more complex vectorial calculation? We&amp;rsquo;ll calculate the actual focal position with the complex calculation for multiple nominal focal positions and compare the to the simpler calculation to see the size of the deviation.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# make some NFPs in ¬µm&lt;/span&gt;
NFP &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; np&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;linspace(&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;8&lt;/span&gt;)

&lt;span style=&#34;color:#75715e&#34;&gt;# calculate the AFPs&lt;/span&gt;
AFP &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; find_afp(NFP, &lt;span style=&#34;color:#ae81ff&#34;&gt;1.0&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;1.3&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0.85&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0.52&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# geometrical stretch&lt;/span&gt;
geom_m &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; otf_ratio(&lt;span style=&#34;color:#ae81ff&#34;&gt;1.0&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;1.3&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0.85&lt;/span&gt;)

fig, ax &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; plt&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;subplots(dpi&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;150&lt;/span&gt;)
ax&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;plot(NFP, AFP[:, &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;], &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;o&amp;#34;&lt;/span&gt;, label&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Vectorial&amp;#34;&lt;/span&gt;)
ax&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;plot(NFP, NFP &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; geom_m, label&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Geometrical&amp;#34;&lt;/span&gt;)
ax&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;set_ylabel(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Actual Focal Position (¬µm)&amp;#34;&lt;/span&gt;)
ax&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;set_xlabel(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Nominal Focal Position (¬µm)&amp;#34;&lt;/span&gt;)
ax&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;set_title(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Calculation Comparison&amp;#34;&lt;/span&gt;)
ax&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;legend()
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;output_15_1.png&#34; alt=&#34;png&#34;&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# geometrical stretch&lt;/span&gt;
geom_m &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; otf_ratio(&lt;span style=&#34;color:#ae81ff&#34;&gt;1.0&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;1.3&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0.85&lt;/span&gt;)

fig, (ax1, ax2) &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; plt&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;subplots(&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, dpi&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;150&lt;/span&gt;, sharex&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;True)
ax1&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;plot(NFP, AFP[:, &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; NFP &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; geom_m, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;o&amp;#34;&lt;/span&gt;)
ax2&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;plot(NFP[&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;:], &lt;span style=&#34;color:#ae81ff&#34;&gt;100&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;((AFP[:, &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; NFP &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; geom_m)&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;AFP[:, &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;])[&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;:], &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;o&amp;#34;&lt;/span&gt;)
ax1&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;set_ylabel(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;$\Delta$ (¬µm)&amp;#34;&lt;/span&gt;)
ax2&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;set_ylabel(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;$\Delta$ (%)&amp;#34;&lt;/span&gt;)
ax2&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;set_xlabel(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Nominal Focal Position (¬µm)&amp;#34;&lt;/span&gt;)
ax1&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;set_title(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Difference between Vectorial and Geometrical Calculations&amp;#34;&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;output_16_1.png&#34; alt=&#34;png&#34;&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;slope_ratio &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; (AFP[&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;:, &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt; NFP[&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;:])&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;mean() &lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt; geom_m
&lt;span style=&#34;color:#66d9ef&#34;&gt;print&lt;/span&gt;(f&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;The ratio between the complex slope and the simple slope is {slope_ratio:.0%}&amp;#34;&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;The ratio between the complex slope and the simple slope is 99%
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;At least as far as focal position is concerned the simple calculation is more than adequate over short distances.&lt;/p&gt;
&lt;h2 id=&#34;conclusions&#34;&gt;Conclusions&lt;/h2&gt;
&lt;p&gt;When talking about three dimensional imaging it seems that NA alone doesn&amp;rsquo;t tell the full story.&lt;sup id=&#34;fnref:7&#34;&gt;&lt;a href=&#34;#fn:7&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;7&lt;/a&gt;&lt;/sup&gt; As shown &lt;a href=&#34;#a-question-of-index&#34;&gt;above&lt;/a&gt;, NA is the sole determinant of lateral resolution but the index of the sample comes into the equation for axial resolution. To put it another way, the lateral resolution of a 0.95 NA water objective is exactly the same (in theory) as the lateral resolution of 0.95 NA air objective &lt;em&gt;but&lt;/em&gt; the axial resolution of the water objective is more than 70% worse! Moreover, index mismatch adds spherical aberration to the images. This can be alleviated to a certain extent with confocal imaging (c.f. Figure 1). Even so, it is to the microscopist&amp;rsquo;s advantage to use an objective with a design index as close as possible to the sample of interest (except in the case of TIRF microscopy).&lt;/p&gt;
&lt;p&gt;If you want to download the Jupyter notebook I used to create this post you can do so &lt;a href=&#34;https://david-hoffman.github.io/files/Vectorial%20Estimation%20of%20focal%20shift.ipynb&#34; target=&#34;_blank&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;section class=&#34;footnotes&#34; role=&#34;doc-endnotes&#34;&gt;
&lt;hr&gt;
&lt;ol&gt;
&lt;li id=&#34;fn:1&#34; role=&#34;doc-endnote&#34;&gt;
&lt;p&gt;&lt;a href=&#34;https://www.osapublishing.org/josaa/abstract.cfm?uri=josaa-12-2-325&#34;&gt;P. T√∂r√∂k, P. Varga, Z. Laczik, G. R. Booker, Electromagnetic diffraction of light focused through a planar interface between materials of mismatched refractive indices: an integral representation. J. Opt. Soc. Am. A, JOSAA. 12, 325‚Äì332 (1995).&lt;/a&gt; &lt;a href=&#34;#fnref:1&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&#34;fn:2&#34; role=&#34;doc-endnote&#34;&gt;
&lt;p&gt;&lt;a href=&#34;http://onlinelibrary.wiley.com/doi/10.1046/j.1365-2818.1997.2440802.x/abstract&#34;&gt;P. T√∂r√∂k, S. J. Hewlett, P. Varga, The role of specimen-induced spherical aberration in confocal microscopy. Journal of Microscopy. 188, 158‚Äì172 (1997).&lt;/a&gt; &lt;a href=&#34;#fnref:2&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&#34;fn:3&#34; role=&#34;doc-endnote&#34;&gt;
&lt;p&gt;&lt;a href=&#34;https://link.springer.com/chapter/10.1007/978-0-387-45524-2_20&#34;&gt;A. Egner, S. W. Hell, in Handbook Of Biological Confocal Microscopy (Springer, Boston, MA, 2006; https://link.springer.com/chapter/10.1007/978-0-387-45524-2_20), pp. 404‚Äì413.&lt;/a&gt; &lt;a href=&#34;#fnref:3&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&#34;fn:4&#34; role=&#34;doc-endnote&#34;&gt;
&lt;p&gt;It should be noted that &lt;a href=&#34;https://en.wikipedia.org/wiki/Fresnel_equations&#34;&gt;Fresnel reflections&lt;/a&gt; at the interface increase with increasing angle such that the apodization function of the pupil rolls off much faster. Thus while the lateral support of the OTF is unchanged its actual shape will be different and will result in lower &lt;em&gt;effective&lt;/em&gt; resolution at lower signal-to-noise ratios. &lt;a href=&#34;#fnref:4&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&#34;fn:5&#34; role=&#34;doc-endnote&#34;&gt;
&lt;p&gt;&lt;a href=&#34;https://onlinelibrary.wiley.com/doi/abs/10.1111/j.1365-2818.1988.tb04563.x&#34;&gt;C. J. R. Sheppard, Depth of field in optical microscopy. Journal of Microscopy. 149, 73‚Äì75 (1988).&lt;/a&gt; &lt;a href=&#34;#fnref:5&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&#34;fn:6&#34; role=&#34;doc-endnote&#34;&gt;
&lt;p&gt;Squishing in frequency which is expansion in real space. &lt;a href=&#34;#fnref:6&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&#34;fn:7&#34; role=&#34;doc-endnote&#34;&gt;
&lt;p&gt;This is definitely true for two dimensional imaging as well: characterizing the frequency response of any system with a single number is always a bad idea. In practice, how the OTF approaches zero transmission is as import, if not more so, than where it hits zero. If your microscope transmits high spatial frequencies, but strongly attenuates them, you&amp;rsquo;ll need a high, and in some cases an unphysically high, signal to noise ratio to make use of them. &lt;a href=&#34;#fnref:7&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;
</description>
    </item>
    
    <item>
      <title>Angle to Position and Back</title>
      <link>https://david-hoffman.github.io/post/angle-to-position-and-back/</link>
      <pubDate>Wed, 11 Mar 2020 13:46:31 -0700</pubDate>
      
      <guid>https://david-hoffman.github.io/post/angle-to-position-and-back/</guid>
      <description>&lt;p&gt;When designing an fluorescent microscope (or general optical system) one often wants to scan the beam position and/or angle at the sample (or object plane). It&amp;rsquo;s useful to remember that for any lens, especially for objective lenses, the back pupil plane is Fourier conjugate to the sample (object) plane of the lens.&lt;sup id=&#34;fnref:1&#34;&gt;&lt;a href=&#34;#fn:1&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;1&lt;/a&gt;&lt;/sup&gt; This has two important consequences for system design.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;A beam that is focused in the back pupil will be collimated at the object plane and &lt;em&gt;vice versa&lt;/em&gt;. For instance, if you completely fill the back pupil of an objective with light (preferably overfilling it) then you will have a diffraction limited spot at the sample plane.&lt;sup id=&#34;fnref:2&#34;&gt;&lt;a href=&#34;#fn:2&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;2&lt;/a&gt;&lt;/sup&gt;&lt;/li&gt;
&lt;li&gt;If the beam enters the back pupil at an angle relative to the optical axis the position at the sample plane will be shifted relative to the optical axis.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Basically: &lt;strong&gt;angle&lt;/strong&gt; in the back pupil is &lt;strong&gt;position&lt;/strong&gt; at the object plane and &lt;strong&gt;position&lt;/strong&gt; in the back pupil is &lt;strong&gt;angle&lt;/strong&gt; at the object plane.&lt;/p&gt;
&lt;h2 id=&#34;scanning-the-beam-position&#34;&gt;Scanning the beam position&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;angle_to_position.png&#34; alt=&#34;How input angle at the back focal plane effects positional offset at the object plane&#34;&gt;&lt;/p&gt;
&lt;p&gt;We can make a simple geometrical argument for this case (see figure above). The most important ray here is the chief ray (solid orange line) which passes through the center of the lens, the marginal rays (dashed orange lines) have been added for clarity. In this case we imagine a collimated beam of light entering the back aperture of an aplanatic lens at an angle $\theta$ with respect to the optical axis. The collimated (parallel) rays converge at the focal plane a distance $f$ away from the lens forming a spot at a perpendicular distance $y$ from the optical axis. We can relate these quantities together with the following equation based solely on geometrical reasoning:&lt;/p&gt;
&lt;p&gt;$$
y = f \tan \theta
$$&lt;/p&gt;
&lt;p&gt;For simple lenses and large angles this equation doesn&amp;rsquo;t hold. But for specially designed optical systems, particularly &lt;a href=&#34;https://www.thorlabs.com/newgrouppage9.cfm?objectgroup_id=2910&#34;&gt;scan lenses&lt;/a&gt; which are designed to specifically for this task, it can hold for very large angles and therefore fields of view.&lt;/p&gt;
&lt;h2 id=&#34;scanning-the-beam-angle&#34;&gt;Scanning the beam angle&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;position_to_angle.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;Here we take a slightly different approach. We know that if we were to launch a ray parallel to the optical axis from the very edge of the objective&amp;rsquo;s back pupil then the ray exiting the front of the objective would make an angle $\theta$ with the optical axis such that $NA = n \sin \theta_{max}$ (the classic equation for numerical aperture). That means that if the ray were launched a distance $y$ from the optical axis that was less than half the pupil diameter we could define an &lt;em&gt;effective&lt;/em&gt; NA as $NA_{eff} = y / f$ where $f$ is the focal length of the lens. We can derive this equation knowing that the pupil &lt;em&gt;diameter&lt;/em&gt; is $D = 2 NA f$. This means we can solve for $\theta$ as a function of $y$.&lt;/p&gt;
&lt;p&gt;$$
\theta = \sin^{-1} \left(\frac{y}{fn}\right)
$$&lt;/p&gt;
&lt;h3 id=&#34;why-arent-the-two-equations-the-same&#34;&gt;Why aren&amp;rsquo;t the two equations the same?&lt;/h3&gt;
&lt;p&gt;I was surprised that these two equations would be different. The best explanation I can come up with is that for a well corrected, high magnification, system (such as a microscope objective) the entrance pupil (the pupil facing the object) is curved (in fact it lies on part of a spherical shell) while the exit pupil (the pupil facing infinity space) is flat. The entrance pupil has to be curved because a single point source (ignoring the fact that it&amp;rsquo;s an oscillating dipole) forms a spherical wave.&lt;/p&gt;
&lt;section class=&#34;footnotes&#34; role=&#34;doc-endnotes&#34;&gt;
&lt;hr&gt;
&lt;ol&gt;
&lt;li id=&#34;fn:1&#34; role=&#34;doc-endnote&#34;&gt;
&lt;p&gt;I&amp;rsquo;ll use sample plane and object plane interchangeably throughout. &lt;a href=&#34;#fnref:1&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&#34;fn:2&#34; role=&#34;doc-endnote&#34;&gt;
&lt;p&gt;Approximately &lt;a href=&#34;https://david-hoffman.github.io/post/things-ive-forgotten&#34;&gt;$\sigma&amp;rsquo; \sigma = \frac{\lambda f}{\pi}$&lt;/a&gt; &lt;a href=&#34;#fnref:2&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;
</description>
    </item>
    
    <item>
      <title>Things I&#39;ve Forgotten</title>
      <link>https://david-hoffman.github.io/post/things-ive-forgotten/</link>
      <pubDate>Wed, 11 Mar 2020 00:00:00 +0000</pubDate>
      
      <guid>https://david-hoffman.github.io/post/things-ive-forgotten/</guid>
      <description>&lt;p&gt;In my professional life I&amp;rsquo;m always learning new things. Regrettably, I&amp;rsquo;m also constantly forgetting things. It seems as though my brain only has enough space for a given number of facts and figures, and that number is constantly changing. I figured, if I&amp;rsquo;ve had to learn something more than once, I may as well make a centralized and permanent note of it. Moreover, if I do it in a public forum (üëã) someone else may benefit from my mistakes.&lt;/p&gt;
&lt;p&gt;This list has been roughly divided into three sections: &lt;a href=&#34;#optics&#34;&gt;&lt;em&gt;Optics&lt;/em&gt;&lt;/a&gt;, &lt;a href=&#34;#lasers&#34;&gt;&lt;em&gt;Lasers&lt;/em&gt;&lt;/a&gt;, and &lt;a href=&#34;#code&#34;&gt;&lt;em&gt;Code&lt;/em&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&#34;optics&#34;&gt;Optics&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;em&gt;Aperature&lt;/em&gt; stops are &lt;em&gt;pupil&lt;/em&gt; conjugate&lt;/li&gt;
&lt;li&gt;&lt;em&gt;Field&lt;/em&gt; stops are &lt;em&gt;sample&lt;/em&gt; conjugate&lt;/li&gt;
&lt;li&gt;Pupil diameter &lt;a href=&#34;https://www.microscopyu.com/microscopy-basics/infinity-optical-systems&#34;&gt;$=2 NA f$&lt;/a&gt;, where the objective&amp;rsquo;s numerical aperture is NA and its effective focal length is $f$. The focal length can be calculated from the magnification and standard tube lens. For example, for a 60X Nikon objective where the tube lens has a nominal focal length of 200 mm the effective focal length of the objective is 200 mm/60 = 3.33 mm.&lt;/li&gt;
&lt;li&gt;Fourier transform property of lens: for a Gaussian beam propagating through a lens the beam sizes at each conjugate plane can be related to one another by the following equation:
$$
\sigma&amp;rsquo; \sigma = \frac{\lambda f}{\pi}
$$
Where $\sigma&#39;$ and $\sigma$ are the beam sizes at each conjugate plane and $\lambda$ is the wavelength of the light and $f$ is the focal length of the lens.&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://david-hoffman.github.io/post/angle-to-position-and-back&#34;&gt;The relationship between angle and position at the sample and angle and position at the back pupil of a microscope objective.&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Herschel&amp;rsquo;s and Abbe&amp;rsquo;s Sine conditions
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Herschel&amp;rsquo;s Condition&lt;/strong&gt; invariance of axial magnification&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Abbe&amp;rsquo;s Sine Condition&lt;/strong&gt; invariance of lateral magnification (and no coma or spherical aberration)&lt;/li&gt;
&lt;li&gt;Impossible to satisfy both conditions &lt;em&gt;simultaneously&lt;/em&gt;, thus perfect volumetric imaging is impossible (this is different from collecting separate 2D planes like in normal microscopy).&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;If one approximates a diffraction limited PSF by a Gaussian profile the standard deviation of the profile is approximately equal to &lt;a href=&#34;https://en.wikipedia.org/wiki/Airy_disk#Approximation_using_a_Gaussian_profile&#34;&gt;$0.45 \lambda / 2 NA$&lt;/a&gt; assuming that the &lt;a href=&#34;https://en.wikipedia.org/wiki/Numerical_aperture&#34;&gt;f-number is approximately equal to $1/2 NA$&lt;/a&gt; (As a consequence: $FWHM \approx \lambda / 2 NA$)&lt;/li&gt;
&lt;li&gt;$f = \left(1 - \sqrt{1 - (\text{NA} / n)^2}\right) / 2$ where $f$ is the fraction of light collected by the objective as a function of numerical aperture (NA) and medium index ($n$). When NA is small this can be approximated as $(NA/n)^2/4$. Derived from &lt;a href=&#34;https://en.wikipedia.org/wiki/Solid_angle&#34;&gt;this&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://onlinelibrary.wiley.com/doi/abs/10.1111/j.1365-2818.1988.tb04563.x&#34;&gt;Depth of field&lt;/a&gt; is &lt;a href=&#34;https://david-hoffman.github.io/post/otf-squishing/&#34;&gt;$\Delta z = \lambda / \left(n_{sample} - \sqrt{n^2_{sample} - \text{NA}^2}\right)$&lt;/a&gt;&lt;sup id=&#34;fnref:1&#34;&gt;&lt;a href=&#34;#fn:1&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;1&lt;/a&gt;&lt;/sup&gt;. If you take the first order term of the Maclaurin series expansion you get the more familiar form of $\Delta z = 2 n \lambda / \text{NA}^2$&lt;/li&gt;
&lt;li&gt;An Airy unit (au) is defined as $1.22 \lambda / \text{NA}$.&lt;/li&gt;
&lt;li&gt;A subtle detail in Gustafsson et al.:&lt;sup id=&#34;fnref:2&#34;&gt;&lt;a href=&#34;#fn:2&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;2&lt;/a&gt;&lt;/sup&gt; for confocal microscopy you can model the total PSF as $PSF_\text{total} = PSF_\text{excitation} \times PSF_\text{detection}$ but this isn&amp;rsquo;t true for SIM or LLSM. The key is in the transformation from equation (4) to equation (5). Here Gustafsson makes the argument that if you keep the axial excitation pattern constant relative to the objective you now multiply the PSF by the axial component of the excitation before the convolution, thus the effective PSF is now $PSF_\text{total} = PSF_\text{axial excitation} \times PSF_\text{detection}$. For confocal, the excitation spot is also scanned so all components of the excitation have the same coordinate frame as the detection and therefore their PSFs can be multiplied. In light-sheet microscopy the light-sheet is (hopefully) kept aligned with focal plane of the detection objective and thus the situation is the same as for SIM, i.e. the effective axial PSF is the multiplication of the axial excitation profile and the axial detection PSF but the lateral PSF is just the lateral detection PSF.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;lasers&#34;&gt;Lasers&lt;/h2&gt;
&lt;h2 id=&#34;lab&#34;&gt;Lab&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://www.henkel-adhesives.com/us/en/product/structural-adhesives/loctite_ea_608.html&#34;&gt;Loctite EA 608&lt;/a&gt; can be removed by applying heat as it&amp;rsquo;s strength decreases with increasing temperature. Using a heat gun at 500+ ¬∞F for ~1 min seems to work for me.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;code&#34;&gt;Code&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;(‚ïØ¬∞‚ñ°¬∞)‚ïØÔ∏µ ‚îª‚îÅ‚îª&lt;/li&gt;
&lt;li&gt;Assuming that &lt;code&gt;in1.shape == in2.shape&lt;/code&gt; then &lt;code&gt;fftconvolve(in1, in2, &amp;quot;same&amp;quot;) != irfftn(rfftn(in1), rfftn(in2))&lt;/code&gt;. The left hand side calculates the convolution with &lt;em&gt;explicit zero padding&lt;/em&gt; while the right hand side calculates the convolution with &lt;em&gt;implicit reflection&lt;/em&gt;.&lt;/li&gt;
&lt;li&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;get_max&lt;/span&gt;(xdata, ydata, axis&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;):
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&amp;#34;&amp;#34;Get the x value that corresponds to the max y value&amp;#34;&amp;#34;&amp;#34;&lt;/span&gt;
    idx_max &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; ydata&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;argmax(axis)
    max_x &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; np&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;take_along_axis(xdata, np&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;expand_dims(idx_max, axis), axis)&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;squeeze()
    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; max_x
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;useful-links&#34;&gt;Useful links&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://www.newport.com/n/focusing-and-collimating&#34;&gt;https://www.newport.com/n/focusing-and-collimating&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://www.loreti.it/chapterspdf/ch06_diffn_effcy.pdf&#34;&gt;http://www.loreti.it/chapterspdf/ch06_diffn_effcy.pdf&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;section class=&#34;footnotes&#34; role=&#34;doc-endnotes&#34;&gt;
&lt;hr&gt;
&lt;ol&gt;
&lt;li id=&#34;fn:1&#34; role=&#34;doc-endnote&#34;&gt;
&lt;p&gt;If $\text{NA} &amp;gt; n_{sample}$ indicating that the objective is being used in a medium that is of a lower index than for which it was designed then $\Delta z = \lambda / n_{sample}$ &lt;a href=&#34;#fnref:1&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&#34;fn:2&#34; role=&#34;doc-endnote&#34;&gt;
&lt;p&gt;&lt;a href=&#34;http://www.sciencedirect.com/science/article/pii/S0006349508703606&#34;&gt;M. G. L. Gustafsson, L. Shao, P. M. Carlton, C. J. R. Wang, I. N. Golubovskaya, W. Z. Cande, D. A. Agard, J. W. Sedat, Three-Dimensional Resolution Doubling in Wide-Field Fluorescence Microscopy by Structured Illumination. Biophysical Journal. 94, 4957‚Äì4970 (2008).&lt;/a&gt; &lt;a href=&#34;#fnref:2&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;
</description>
    </item>
    
    <item>
      <title>Conversion Factors</title>
      <link>https://david-hoffman.github.io/post/conversion-factors/</link>
      <pubDate>Wed, 04 Mar 2020 15:41:25 -0800</pubDate>
      
      <guid>https://david-hoffman.github.io/post/conversion-factors/</guid>
      <description>&lt;h2 id=&#34;energy-conversion-factors&#34;&gt;Energy Conversion Factors&lt;/h2&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&#34;center&#34;&gt;1 kcal/mol&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;0.04336 eV&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;0.00159 h&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;349.75 cm$^{-1}$&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;6.948 √ó 10$^{-14}$ erg&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;4.184 kJ/mol&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&#34;center&#34;&gt;1 eV&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;23.06 kcal/mol&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;0.03675 h&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;8065.6 cm$^{-1}$&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;1.602 √ó 10$^{-12}$ erg&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&#34;center&#34;&gt;1 h&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;627.51 kcal/mol&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;27.212 eV&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;219,474.6 cm$^{-1}$&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;4.36 √ó 10$^{-11}$ erg&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;2 Ry&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&#34;center&#34;&gt;1 erg&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;1.439 √ó 10$^{13}$ kcal/mol&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;6.2415 √ó 10$^{11}$ eV&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;2.2937 √ó 10$^{10}$ h&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;5.034 √ó 10$^{15}$ cm$^{-1}$&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h2 id=&#34;colors-of-light&#34;&gt;Colors of Light&lt;/h2&gt;
&lt;h3 id=&#34;visible-light&#34;&gt;Visible Light&lt;/h3&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Color&lt;/th&gt;
&lt;th&gt;nm&lt;/th&gt;
&lt;th&gt;eV&lt;/th&gt;
&lt;th&gt;$\text{cm}^{-1}$&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;Red&lt;/td&gt;
&lt;td&gt;700&lt;/td&gt;
&lt;td&gt;1.77&lt;/td&gt;
&lt;td&gt;14,300&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Orange&lt;/td&gt;
&lt;td&gt;620&lt;/td&gt;
&lt;td&gt;2.00&lt;/td&gt;
&lt;td&gt;16,100&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Yellow&lt;/td&gt;
&lt;td&gt;580&lt;/td&gt;
&lt;td&gt;2.14&lt;/td&gt;
&lt;td&gt;17,300&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Green&lt;/td&gt;
&lt;td&gt;530&lt;/td&gt;
&lt;td&gt;2.34&lt;/td&gt;
&lt;td&gt;18,900&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Blue&lt;/td&gt;
&lt;td&gt;470&lt;/td&gt;
&lt;td&gt;2.64&lt;/td&gt;
&lt;td&gt;21,300&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Violet&lt;/td&gt;
&lt;td&gt;420&lt;/td&gt;
&lt;td&gt;2.95&lt;/td&gt;
&lt;td&gt;23,800&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id=&#34;all-light&#34;&gt;All Light&lt;/h3&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Color&lt;/th&gt;
&lt;th align=&#34;center&#34;&gt;nm&lt;/th&gt;
&lt;th align=&#34;center&#34;&gt;eV&lt;/th&gt;
&lt;th align=&#34;center&#34;&gt;$\text{cm}^{-1}$&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;Radio&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;$3\times 10^{12}$ &amp;mdash; $3\times 10^{8}$&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;$4\times 10^{-10}$ &amp;mdash; $4\times 10^{-6}$&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;$3\times 10^{-6}$ &amp;mdash; $3\times 10^{-2}$&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Microwaves&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;$3\times 10^{8}$ &amp;mdash; $3\times 10^{6}$&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;$4\times 10^{-6}$ &amp;mdash; $4\times 10^{-4}$&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;$3\times 10^{-2}$ &amp;mdash; $3$&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Far IR&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;$3\times 10^{6}$ &amp;mdash; $3\times 10^{4}$&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;$4\times 10^{-4}$ &amp;mdash; $4\times 10^{-2}$&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;$3$ &amp;mdash; $300$&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Near IR&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;$3\times 10^{4}$ &amp;mdash; $700$&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;$4\times 10^{-2}$ &amp;mdash; $2$&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;$300$ &amp;mdash; $15,000$&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Visible&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;$700$ &amp;mdash; $420$&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;$2$ &amp;mdash; $3$&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;$15,000$ &amp;mdash; $24,000$&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Near UV&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;$420$ &amp;mdash; $300$&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;$3$ &amp;mdash; $4$&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;$24,000$ &amp;mdash; $30,000$&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Vac UV&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;$300$ &amp;mdash; $3$&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;$4$ &amp;mdash; $400$&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;$30,000$ &amp;mdash; 3\e{6}&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;X-rays&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;$3$ &amp;mdash; $0.003$&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;$400$ &amp;mdash; $4\times 10^{5}$&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;$3\times 10^{6}$ &amp;mdash; $3\times 10^{9}$&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h2 id=&#34;free-energies&#34;&gt;Free Energies&lt;/h2&gt;
&lt;p&gt;$$
\Delta(G) = RT \ln(K)
$$
$$
\Delta(G_1) - \Delta(G_2) = RT\ln\left(\frac{K_1}{K_2}\right)
$$
$$
\Delta\Delta(G) = 1\text{ kcal/mol} \Longleftrightarrow \frac{K_1}{K_2} = 5.4
$$
$$
\frac{K_1}{K_2} = 10^1 \Longleftrightarrow \Delta\Delta G = 1.36
$$
$$
\frac{K_1}{K_2} = 10^2 \Longleftrightarrow \Delta\Delta G = 2.76
$$
$$
\frac{K_1}{K_2} = 10^4 \Longleftrightarrow \Delta\Delta G = 5.53
$$
$$
\frac{K_1}{K_2} = 10^6 \Longleftrightarrow \Delta\Delta G = 8.29
$$
$$
\Delta G = 1.36 \left( pK_{a1} - pK_{a2}\right)
$$&lt;/p&gt;
&lt;h2 id=&#34;atomic-units&#34;&gt;Atomic Units&lt;/h2&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Length&lt;/th&gt;
&lt;th align=&#34;center&#34;&gt;Bohr radius, $a_0$&lt;/th&gt;
&lt;th align=&#34;right&#34;&gt;0.52918 √Ö&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;Force Constant&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;1 au&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;$1.5569 \times 10^6$ dyn/cm&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Mass&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;au, m$_\text{e}$&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;$9.1095\times 10^{-31}$ kg&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;$5.5\times 10^{-4}$ amu&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;amu, m($^{12}$C)/12&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;$1.66\times 10^{-27}$ kg&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;1822 au&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Time&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;au&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;$2.4189\times 10^{-17}$ s&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Dipole Moment&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;au&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;2.54 D&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;$8.478\times 10^{-30}$ C-m&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h2 id=&#34;miscellaneous&#34;&gt;Miscellaneous&lt;/h2&gt;
&lt;h3 id=&#34;force-constants&#34;&gt;Force Constants&lt;/h3&gt;
&lt;p&gt;$$
1\text{ dyn/cm} = 1.44 \times 10^{-3}\frac{\text{ kcal/mol}}{\text{√Ö}^2}
$$
$$
1\text{ Mdyn/cm} = 1440\frac{\text{ kcal/mol}}{\text{√Ö}^2}
$$&lt;/p&gt;
&lt;h3 id=&#34;thermal&#34;&gt;Thermal&lt;/h3&gt;
&lt;p&gt;$$
k_BT (298\text{ K}) = 9.4366 \times 10^{-4}\text{ h}
$$
$$
RT (298\text{ K}) = 2.4789\text{ kJ/mol} = 0.5925\text{ kcal/mol}
$$
$$
e^2 = 14.3998\text{ eV-√Ö} = 332.059\text{ (kcal/mol)-√Ö}
$$&lt;/p&gt;
&lt;a href=&#34;https://david-hoffman.github.io/files/conversion_factors.pdf&#34; target=&#34;_blank&#34;&gt;Download a prettier PDF version of this post&lt;/a&gt;
</description>
    </item>
    
    <item>
      <title>Derivation of the Transform Limit</title>
      <link>https://david-hoffman.github.io/post/transform-limit/</link>
      <pubDate>Wed, 04 Mar 2020 15:24:05 -0800</pubDate>
      
      <guid>https://david-hoffman.github.io/post/transform-limit/</guid>
      <description>&lt;p&gt;Let us define the dispersion of a function about zero as,&lt;/p&gt;
&lt;p&gt;$$
D_0(f)=\int_{-\infty}^\infty x^2 |f(x)|^2 dx
$$&lt;/p&gt;
&lt;p&gt;Where $f(x)$ is some normalized square integrable function. In this case we&amp;rsquo;ll use a gaussian which is defined as,&lt;/p&gt;
&lt;p&gt;$$
f(x)\propto e^{-x^2/2\sigma^2}
$$&lt;/p&gt;
&lt;p&gt;This could be, for instance, the amplitude of the electric field of some laser pulse. We also know that the fourier transform of a gaussian is still a gaussian, i.e.&lt;/p&gt;
&lt;p&gt;$$
\mathcal{F}[f(x)](k)=\hat{f}(k)\propto e^{-2\pi^2\sigma^2k^2}
$$&lt;/p&gt;
&lt;p&gt;We can relate the two dispersions to one another by multiplying them together, i.e.,&lt;/p&gt;
&lt;p&gt;$$
D_0(f)D_0(\hat{f})=\sigma^2_x\sigma^2_k
$$&lt;/p&gt;
&lt;p&gt;Remember that we know&lt;/p&gt;
&lt;p&gt;$$
\sigma^2=\int_{-\infty}^{\infty}x^2\frac{e^{-x^2/2\sigma^2}}{\sqrt{2\pi\sigma^2}}dx
$$&lt;/p&gt;
&lt;p&gt;Using this fact we can say that&lt;/p&gt;
&lt;p&gt;$$
\sigma^2_x=\frac{\sigma^2}{2}
$$&lt;/p&gt;
&lt;p&gt;And&lt;/p&gt;
&lt;p&gt;$$
\sigma^2_k=\frac{1}{8\pi^2\sigma^2}
$$&lt;/p&gt;
&lt;p&gt;Which means that our dispersion relation is&lt;/p&gt;
&lt;p&gt;$$
D_0(f)D_0(\hat{f})=\frac{1}{16\pi^2}
$$&lt;/p&gt;
&lt;p&gt;We can relate this to the FWHM of our pulse in either the $x$ or $k$ domain using the fact that $\text{FWHM}=2 \sqrt{2\ln 2} \sigma $,&lt;/p&gt;
&lt;p&gt;$$
\Delta x \Delta k=\frac{2\ln2}{\pi}\approx0.441
$$&lt;/p&gt;
&lt;p&gt;Where $\Delta x$ is the FWHM of the square of $f(x)$ in the $x$ domain. For instance, if $f(x)$ was the electric field of our pulse than $|f(x)|^2$ would be the intensity that we would measure of the pulse and $\Delta x$ would be the measured FWHM of the intensity of the pulse.&lt;/p&gt;
&lt;p&gt;We can make this more concrete by saying that we measured the frequency of the pulse in cm$^{-1}$ and the duration in fs,&lt;/p&gt;
&lt;p&gt;$$
\Delta t (\text{fs}) \Delta \nu (\text{cm}^{-1})\left(\frac{ 2.99 \times 10^{-5}\text{ cm}}{\text{fs}}\right)=0.441
$$&lt;/p&gt;
&lt;p&gt;We can rearrange this to be&lt;/p&gt;
&lt;p&gt;$$
\Delta t (\text{fs}) \Delta \nu (\text{cm}^{-1})=1470\text{ fs cm}^{-1}
$$&lt;/p&gt;
&lt;p&gt;Or&lt;/p&gt;
&lt;p&gt;$$
\Delta t (\text{ps}) \Delta \nu (\text{cm}^{-1})=15\text{ ps cm}^{-1}
$$&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Freeze-frame of whole cells</title>
      <link>https://david-hoffman.github.io/publication/clem/</link>
      <pubDate>Fri, 17 Jan 2020 00:00:00 +0000</pubDate>
      
      <guid>https://david-hoffman.github.io/publication/clem/</guid>
      <description>&lt;p&gt;This is my favorite movie from the paper.&lt;/p&gt;
&lt;p&gt;
&lt;div style=&#34;position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;&#34;&gt;
  &lt;iframe src=&#34;https://player.vimeo.com/video/383152270&#34; style=&#34;position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;&#34; title=&#34;vimeo video&#34; webkitallowfullscreen mozallowfullscreen allowfullscreen&gt;&lt;/iframe&gt;
 &lt;/div&gt;

&lt;blockquote class=&#34;twitter-tweet&#34;&gt;&lt;p lang=&#34;en&#34; dir=&#34;ltr&#34;&gt;It&amp;#39;s here!!!&lt;a href=&#34;https://t.co/11j9LUa7xu&#34;&gt;https://t.co/11j9LUa7xu&lt;/a&gt;&lt;br&gt;OMG! OMG! üò±üò±üò±&lt;/p&gt;&amp;mdash; David Hoffman (@davephoffman) &lt;a href=&#34;https://twitter.com/davephoffman/status/1217884019817189376?ref_src=twsrc%5Etfw&#34;&gt;January 16, 2020&lt;/a&gt;&lt;/blockquote&gt;
&lt;script async src=&#34;https://platform.twitter.com/widgets.js&#34; charset=&#34;utf-8&#34;&gt;&lt;/script&gt;
&lt;/p&gt;
&lt;!-- raw HTML omitted --&gt;
</description>
    </item>
    
    <item>
      <title>Tiled Reconstruction Improves Structured Illumination Microscopy</title>
      <link>https://david-hoffman.github.io/publication/sim-tiling/</link>
      <pubDate>Sat, 11 Jan 2020 00:00:00 +0000</pubDate>
      
      <guid>https://david-hoffman.github.io/publication/sim-tiling/</guid>
      <description></description>
    </item>
    
    <item>
      <title>Difference Bands TCNE</title>
      <link>https://david-hoffman.github.io/publication/difference-bands-tcne/</link>
      <pubDate>Wed, 21 Mar 2018 00:00:00 +0000</pubDate>
      
      <guid>https://david-hoffman.github.io/publication/difference-bands-tcne/</guid>
      <description></description>
    </item>
    
    <item>
      <title>Good vibrations?</title>
      <link>https://david-hoffman.github.io/publication/accounts-chemical-research/</link>
      <pubDate>Tue, 22 Mar 2016 00:00:00 +0000</pubDate>
      
      <guid>https://david-hoffman.github.io/publication/accounts-chemical-research/</guid>
      <description></description>
    </item>
    
    <item>
      <title>Opv Film Fsrs</title>
      <link>https://david-hoffman.github.io/publication/opv-film-fsrs/</link>
      <pubDate>Mon, 15 Jun 2015 00:00:00 +0000</pubDate>
      
      <guid>https://david-hoffman.github.io/publication/opv-film-fsrs/</guid>
      <description></description>
    </item>
    
    <item>
      <title>Ring Opening</title>
      <link>https://david-hoffman.github.io/publication/ring-opening/</link>
      <pubDate>Thu, 05 Mar 2015 00:00:00 +0000</pubDate>
      
      <guid>https://david-hoffman.github.io/publication/ring-opening/</guid>
      <description></description>
    </item>
    
    <item>
      <title>Observing a reactive conical intersection</title>
      <link>https://david-hoffman.github.io/publication/conical-intersection/</link>
      <pubDate>Mon, 16 Jun 2014 00:00:00 +0000</pubDate>
      
      <guid>https://david-hoffman.github.io/publication/conical-intersection/</guid>
      <description></description>
    </item>
    
    <item>
      <title>PhD Thesis</title>
      <link>https://david-hoffman.github.io/publication/thesis/</link>
      <pubDate>Fri, 16 May 2014 00:00:00 +0000</pubDate>
      
      <guid>https://david-hoffman.github.io/publication/thesis/</guid>
      <description></description>
    </item>
    
    <item>
      <title>Ndab Isrs</title>
      <link>https://david-hoffman.github.io/publication/ndab-isrs/</link>
      <pubDate>Fri, 18 Oct 2013 00:00:00 +0000</pubDate>
      
      <guid>https://david-hoffman.github.io/publication/ndab-isrs/</guid>
      <description></description>
    </item>
    
    <item>
      <title>Etalon Fsrs</title>
      <link>https://david-hoffman.github.io/publication/etalon-fsrs/</link>
      <pubDate>Fri, 06 Sep 2013 00:00:00 +0000</pubDate>
      
      <guid>https://david-hoffman.github.io/publication/etalon-fsrs/</guid>
      <description></description>
    </item>
    
    <item>
      <title>Dye Sensitized Fsrs</title>
      <link>https://david-hoffman.github.io/publication/dye-sensitized-fsrs/</link>
      <pubDate>Wed, 13 Mar 2013 00:00:00 +0000</pubDate>
      
      <guid>https://david-hoffman.github.io/publication/dye-sensitized-fsrs/</guid>
      <description></description>
    </item>
    
    <item>
      <title>Ndab</title>
      <link>https://david-hoffman.github.io/publication/ndab-fsrs/</link>
      <pubDate>Wed, 01 Feb 2012 00:00:00 +0000</pubDate>
      
      <guid>https://david-hoffman.github.io/publication/ndab-fsrs/</guid>
      <description></description>
    </item>
    
  </channel>
</rss>
