<!DOCTYPE html>
<html lang="en-us">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academia 4.3.1">
  <meta name="generator" content="Hugo 0.74.3" />

  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="David P. Hoffman">

  
  
  
    
  
  <meta name="description" content="How to make your images look bad with high NA objectives">

  
  <link rel="alternate" hreflang="en-us" href="https://david-hoffman.github.io/post/otf-squishing/">

  


  

  
  
  
  <meta name="theme-color" content="#fc6f5c">
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.0/css/all.css" integrity="sha384-aOkxzJ5uQz7WBObEZcHvV5JvRW3TUc2rNPA7pe3AwnsUohiw1Vj2Rgx2KSOkF5+h" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" integrity="sha256-ygkqlh3CYSUri3LhQxzdcm0n1EQvH2Y+U5S2idbLtxs=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/github.min.css" crossorigin="anonymous" title="hl-light">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/github.min.css" crossorigin="anonymous" title="hl-dark" disabled>
      
    

    

    

  

  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Open+Sans|Roboto+Mono&display=swap">
  

  
  
  
  <link rel="stylesheet" href="/css/academia.min.4e3b2f408b00c06405993e164c128cb2.css">

  

  
  
  
    <script>
      window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
      ga('create', 'UA-159401260-1', 'auto');
      
      ga('require', 'eventTracker');
      ga('require', 'outboundLinkTracker');
      ga('require', 'urlChangeTracker');
      ga('send', 'pageview');
    </script>
    <script async src="//www.google-analytics.com/analytics.js"></script>
    
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/autotrack/2.4.1/autotrack.js" integrity="sha512-HUmooslVKj4m6OBu0OgzjXXr+QuFYy/k7eLI5jdeEy/F4RSgMn6XRWRGkFi5IFaFgy7uFTkegp3Z0XnJf3Jq+g==" crossorigin="anonymous"></script>
    
  
  

  

  <link rel="manifest" href="/site.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="https://david-hoffman.github.io/post/otf-squishing/">

  
  
  
  
    
  
  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="twitter:site" content="@davephoffman">
  <meta property="twitter:creator" content="@davephoffman">
  
  <meta property="og:site_name" content="David P. Hoffman, PhD.">
  <meta property="og:url" content="https://david-hoffman.github.io/post/otf-squishing/">
  <meta property="og:title" content="Oh no, I squished my OTF! | David P. Hoffman, PhD.">
  <meta property="og:description" content="How to make your images look bad with high NA objectives"><meta property="og:image" content="https://david-hoffman.github.io/post/otf-squishing/featured.png">
  <meta property="twitter:image" content="https://david-hoffman.github.io/post/otf-squishing/featured.png"><meta property="og:locale" content="en-us">
  
  <meta property="article:published_time" content="2020-04-11T00:00:00&#43;00:00">
  
  <meta property="article:modified_time" content="2020-07-15T22:35:21-07:00">
  

  


  





  <title>Oh no, I squished my OTF! | David P. Hoffman, PhD.</title>

</head>


<body id="top" data-spy="scroll" data-target="#TableOfContents" data-offset="71" >

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  
<nav class="navbar navbar-light fixed-top navbar-expand-lg py-0" id="navbar-main">
  <div class="container">

    
      <a class="navbar-brand" href="/">David P. Hoffman, PhD.</a>
      
      <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation"><span><i class="fas fa-bars"></i></span>
      </button>
      

    
    <div class="collapse navbar-collapse" id="navbar">
      
      
      <ul class="navbar-nav ml-auto">
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#about"><span>about me</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#posts"><span>blog</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#publication"><span>publications</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#contact"><span>contact me</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link " href="/files/cv.pdf"><span>resume</span></a>
        </li>

        
        

      

        

        

        

        
        <li class="nav-item">
          <a class="nav-link js-dark-toggle" href="#"><i class="fas fa-moon" aria-hidden="true"></i></a>
        </li>
        

      </ul>
    </div>
  </div>
</nav>


  <article class="article py-5" itemscope itemtype="http://schema.org/Article">

  













<div class="container split-header">
  <div class="row justify-content-center">
    <div class="col-lg-8">
        <img class="img-fluid w-100" src="/post/otf-squishing/featured_huaa3e9352c88b1136a75e92c15e3241aa_101195_680x500_fill_q90_lanczos_smart1_2.png" itemprop="image" alt="">
        <span
          class="article-header-caption">Geometrical proof of squishing</span>
    </div>
    <div class="col-lg-8">
      <h1 itemprop="name">Oh no, I squished my OTF!</h1>

      
      <p class="page-subtitle">How to make your images look bad with high NA objectives</p>
      

      



<meta content="2020-04-11 00:00:00 &#43;0000 UTC" itemprop="datePublished">
<meta content="2020-07-15 22:35:21 -0700 PDT" itemprop="dateModified">

<div class="article-metadata">

  
  
  
  
  <div>
    



  <span itemprop="author name" itemtype="http://schema.org/Person"><a href="/authors/admin/">David P. Hoffman</a></span>

  </div>
  
  

  
  <span class="article-date">
    
    
      
          Last updated on
      
    
    <time>Jul 15, 2020</time>
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    11 min read
  </span>
  

  
  

  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fas fa-folder"></i>
    <a href="/categories/a-supplemental-journey/">a supplemental journey</a></span>
  

  
    

  

</div>

      














    </div>
    
    </div>
  </div>
</div>

  <div class="article-container">

    <div class="article-style" itemprop="articleBody">
      <h2 id="a-question-of-index">A question of index</h2>
<p>Something I learned the hard way during my post-doc is the effect index mismatching can have on images taken with high NA air objectives (in my case a Nikon CFI L Plan EPI CRB 100X 0.85 NA lens). Many<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> previous<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup> authors<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup> have commented on and analyzed degradation of image quality when the index for which an objective is designed does not match the one in which it is used. Even so, many users of optical microscopes remain unaware of this issue. The problems induced by index mismatch can be summarized as follows (where $n_{obj}$ is the design index and $n_{sample}$ is the mounting index):</p>
<ol>
<li>NA is reduced to the index of the specimen, i.e. $NA = n_{sample}$, when $n_{obj} &gt; n_{sample}$</li>
<li>Compression of the image when $n_{obj} &lt; n_{sample}$ and a concomitant reduction in expected axial resolution</li>
<li>Increasing spherical aberration as the objective&rsquo;s focus is moved deeper into the sample when $n_{obj} \neq n_{sample}$</li>
</ol>
<p>To explain the first problem imagine we are imaging a point source radiating spherical waves of light embedded in a medium of index $n_{sample}$ near the interface with a medium of index $n_{obj}$ (c.f. Figure 1). After a certain axial distance the spherical wave encounters the interface and refracts. Appealing to geometrical optical arguments we say that only the bottom hemisphere of light can be captured. The maximum angle of rays that can be captured are rays that propagate along the interface (i.e. at an angle of 90° relative to the interface normal) and these are refracted at an angle <a href="https://en.wikipedia.org/wiki/Total_internal_reflection#Critical_angle">$\theta_c = \arcsin(n_{sample}/n_{obj})$</a>. According to <a href="https://en.wikipedia.org/wiki/Snell%27s_law">Snell&rsquo;s law</a> and the definition for <a href="https://en.wikipedia.org/wiki/Numerical_aperture">NA</a> this means that the maximum possible NA for this configuration is $NA = n_{obj} \sin(\theta_c) = n_{sample} \sin(\pi/2) = n_{sample}$</p>






<figure>

  <a data-fancybox="" href="TIRF_Diagram.png" >

<img src="TIRF_Diagram.png" >
</a>


<figcaption data-pre="Figure " data-post=":" class="numbered">
  <h4>A point source emitting from a lower index material to a higher index material</h4>
  
</figcaption>

</figure>

<p>The second problem, when $n_{obj} &lt; n_{sample}$, is trickier and I covered it in some detail in the <a href="http://science.sciencemag.org/content/367/6475/eaaz5357/suppl/DC1">supplemental material</a> of our <a href="https://science.sciencemag.org/content/367/6475/eaaz5357">cryo paper</a>. Looking at the OTF support in the $k_xk_z$ plane, as shown in Figure 2, we can see that the OTF gets &ldquo;squished&rdquo; in the $k_z$ direction. A key insight is that while the lateral resolution is independent of index due to Snell&rsquo;s law, $NA = n_{obj}\sin(\theta_{obj}) = n_{sample}\sin(\theta_{sample})$, the axial resolution is not.<sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup> Axial resolution (sometimes termed <a href="https://en.wikipedia.org/wiki/Depth_of_field">depth of field</a> or depth of focus) for high NA systems has been derived before<sup id="fnref:5"><a href="#fn:5" class="footnote-ref" role="doc-noteref">5</a></sup> and can be modified for differing indices of refraction to be</p>
<p>$$
\Delta z = \frac{\lambda}{n_{sample} - \sqrt{n_{sample}^2 - NA^2}}
$$</p>
<p>and herein lies the observed squishing effect<sup id="fnref:6"><a href="#fn:6" class="footnote-ref" role="doc-noteref">6</a></sup>: as $n_{sample}$ increases relative to $NA$ the denominator decreases and $\Delta z$ increases.</p>






<figure>

  <a data-fancybox="" href="featured.png" >

<img src="featured.png" >
</a>


<figcaption data-pre="Figure " data-post=":" class="numbered">
  <h4>OTF support for fixed NA and variable index of refraction ($n$), specifically comparing air ($n=1$) to vitreous ice ($n=1.3$)</h4>
  
</figcaption>

</figure>

<p>Investigating the third problem will require real math based on the work of Török<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>, Török<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>, and Egner.<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup></p>
<h2 id="focal-plane-displacement-in-mismatched-media-a-vectorial-calculation">Focal plane displacement in mismatched media, a Vectorial Calculation</h2>
<p>I&rsquo;ll be following the notation of Egner<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>. Equation 9 gives the vectorial point spread function in terms of three diffraction integrals. Note that for on axis light ($x=0$ and $y=0$) the integrands of $I_1(\vec{r})$ and  $I_2(\vec{r})$ are $0$ and $I_0(\vec{r})$ reduces to</p>
<p>$$
I_0(z) = \int_0^\alpha \sqrt{\cos(\theta_1)}\sin(\theta_1)(\tau_s+\tau_p \cos(\theta_2))\exp(ik(\Phi(NFP)+n_2z\cos(\theta_2)))d\theta_1
$$</p>
<p>Where</p>
<p>$$
\Phi(NFP) = -NFP(n_1\cos\theta_1-n_2\cos\theta_2)
$$</p>
<p>$k$ is the wavenumber of the light rays <em>in vacuo</em>, i.e. $k = 2\pi/\lambda$. $\alpha$ is the aperture semi-angle of the lens, i.e. $\text{NA}=n_1 \sin\alpha$. Note that $n_1 = n_{obj}$ and $n_2 = n_{sample}$.</p>
<p>We can now implement these functions in Python.</p>
<h2 id="python-time">Python time</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">%</span>pylab inline
<span style="color:#f92672">import</span> scipy.integrate
<span style="color:#f92672">import</span> scipy.optimize

<span style="color:#f92672">import</span> seaborn <span style="color:#f92672">as</span> sns

sns<span style="color:#f92672">.</span>set()
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">complex_quadrature</span>(func, a, b, <span style="color:#f92672">**</span>kwargs):
    <span style="color:#e6db74">&#34;&#34;&#34;scipy.integrate.quad doesn&#39;t deal with complex numbers, so this hack does&#34;&#34;&#34;</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">real_func</span>(x):
        <span style="color:#66d9ef">return</span> real(func(x))
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">imag_func</span>(x):
        <span style="color:#66d9ef">return</span> imag(func(x))
    real_integral <span style="color:#f92672">=</span> scipy<span style="color:#f92672">.</span>integrate<span style="color:#f92672">.</span>quad(real_func, a, b, <span style="color:#f92672">**</span>kwargs)
    imag_integral <span style="color:#f92672">=</span> scipy<span style="color:#f92672">.</span>integrate<span style="color:#f92672">.</span>quad(imag_func, a, b, <span style="color:#f92672">**</span>kwargs)
    <span style="color:#66d9ef">return</span> (real_integral[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">+</span> <span style="color:#ae81ff">1j</span><span style="color:#f92672">*</span>imag_integral[<span style="color:#ae81ff">0</span>], real_integral[<span style="color:#ae81ff">1</span>:], imag_integral[<span style="color:#ae81ff">1</span>:])

</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a6e22e">@vectorize</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">i0</span>(z, NFP, n1, n2, NA, wl):
    <span style="color:#e6db74">&#34;&#34;&#34;This calculates e-field amplitude _relative to_ NFP, only along the z axis with x, y = 0, 0&#34;&#34;&#34;</span>
    theta_max <span style="color:#f92672">=</span> arcsin(NA <span style="color:#f92672">/</span> n1)
    
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">integrand</span>(theta1):
        sin_t1 <span style="color:#f92672">=</span> sin(theta1)
        theta2 <span style="color:#f92672">=</span> arcsin(n1 <span style="color:#f92672">*</span> sin_t1 <span style="color:#f92672">/</span> n2)
        sin_t2 <span style="color:#f92672">=</span> sin(theta2)
        cos_t1 <span style="color:#f92672">=</span> cos(theta1)
        cos_t2 <span style="color:#f92672">=</span> cos(theta2)
        ts <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> sin_t2 <span style="color:#f92672">*</span> cos_t1 <span style="color:#f92672">/</span> sin(theta1 <span style="color:#f92672">+</span> theta2)
        tp <span style="color:#f92672">=</span> ts <span style="color:#f92672">/</span> cos(theta1 <span style="color:#f92672">-</span> theta2)
        
        k <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> pi <span style="color:#f92672">/</span> wl
        phi <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>NFP <span style="color:#f92672">*</span> (n1 <span style="color:#f92672">*</span> cos_t1 <span style="color:#f92672">-</span> n2 <span style="color:#f92672">*</span> cos_t2)
        <span style="color:#75715e"># make sure i is complex</span>
        i <span style="color:#f92672">=</span> exp(<span style="color:#ae81ff">1j</span> <span style="color:#f92672">*</span> k <span style="color:#f92672">*</span> (phi <span style="color:#f92672">+</span> n2 <span style="color:#f92672">*</span> z <span style="color:#f92672">*</span> cos_t2))
        i <span style="color:#f92672">*=</span> sqrt(cos_t1) <span style="color:#f92672">*</span> sin_t1 <span style="color:#f92672">*</span> (ts <span style="color:#f92672">+</span> tp <span style="color:#f92672">*</span> cos_t2)
        <span style="color:#66d9ef">return</span> i
        
    <span style="color:#66d9ef">return</span> complex_quadrature(integrand, <span style="color:#ae81ff">0</span>, theta_max)[<span style="color:#ae81ff">0</span>]
</code></pre></div><p>A short test to see if the calculation works using the example from Egner and Hell a 1.518 oil objective 1.47 NA</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">z <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>linspace(<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">128</span>)
a_exc <span style="color:#f92672">=</span> i0(z, <span style="color:#f92672">-</span><span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">1.518</span>, <span style="color:#ae81ff">1.47</span>, <span style="color:#ae81ff">1.33</span>, <span style="color:#ae81ff">0.514</span>)
a_em <span style="color:#f92672">=</span> i0(z, <span style="color:#f92672">-</span><span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">1.518</span>, <span style="color:#ae81ff">1.47</span>, <span style="color:#ae81ff">1.33</span>, <span style="color:#ae81ff">0.59</span>)

fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(dpi<span style="color:#f92672">=</span><span style="color:#ae81ff">150</span>)
ax<span style="color:#f92672">.</span>plot(z, abs(a_exc)<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Excitation PSF&#34;</span>)
ax<span style="color:#f92672">.</span>plot(z, abs(a_em)<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Emission PSF&#34;</span>)
ax<span style="color:#f92672">.</span>plot(z, abs(a_exc)<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> abs(a_em)<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Confocal PSF&#34;</span>)
ax<span style="color:#f92672">.</span>legend()
ax<span style="color:#f92672">.</span>yaxis<span style="color:#f92672">.</span>set_major_locator(plt<span style="color:#f92672">.</span>NullLocator())
ax<span style="color:#f92672">.</span>set_xlabel(<span style="color:#e6db74">&#34;Axial Position (µm)&#34;</span>)
ax<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74">&#34;Computation Test, Oil Objective&#34;</span>)
</code></pre></div><p><img src="output_4_1.png" alt="png"></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># we need an esimate of the focal shift in order to reduce computation time</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">otf_ratio</span>(n1, n2, NA):
    <span style="color:#e6db74">&#34;&#34;&#34;The OTF ratio as calculated from the geometrical proof&#34;&#34;&#34;</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">func</span>(n):
        <span style="color:#75715e"># fmax takes care of limiting NA</span>
        <span style="color:#66d9ef">return</span> n <span style="color:#f92672">-</span> sqrt(np<span style="color:#f92672">.</span>fmax(<span style="color:#ae81ff">0</span>, n<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">-</span> NA<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>))
    <span style="color:#66d9ef">return</span> func(n1) <span style="color:#f92672">/</span> func(n2)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_find_afp</span>(NFP, n1, n2, NA, wl_ex, wl_em<span style="color:#f92672">=</span>None, <span style="color:#f92672">*</span>, res<span style="color:#f92672">=</span><span style="color:#ae81ff">32</span>, width<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>, ax<span style="color:#f92672">=</span>None):
    <span style="color:#e6db74">&#34;&#34;&#34;Find the _apparent_ focal position based on the nominal focal position&#34;&#34;&#34;</span>
    
    <span style="color:#75715e"># if no emission wavelength is given, then calculate the widefield PSF</span>
    <span style="color:#66d9ef">if</span> wl_em <span style="color:#f92672">is</span> None:
        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">i0_min</span>(z):
            <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>abs(i0(z, NFP, n1, n2, NA, wl_ex))<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>
    <span style="color:#75715e"># otherwise calculate the confocal PSF</span>
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">i0_min</span>(z):
            toreturn <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>abs(i0(z, NFP, n1, n2, NA, wl_ex))<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span> 
            <span style="color:#66d9ef">return</span> toreturn <span style="color:#f92672">*</span> abs(i0(z, NFP, n1, n2, NA, wl_em))<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>
        
    <span style="color:#75715e"># calculate the approximate focal shift, so the optimization is close to the optimum</span>
    focal_shift <span style="color:#f92672">=</span> otf_ratio(n1, n2, NA)
    
    <span style="color:#75715e"># make a rough low res estimate relative to the estimated focal shift</span>
    low_res_z <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>linspace(<span style="color:#f92672">-</span>width, width, res) <span style="color:#f92672">+</span> NFP <span style="color:#f92672">*</span> (focal_shift <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)
    low_res_a <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>i0_min(low_res_z)
    low_res_max_idx <span style="color:#f92672">=</span> low_res_a<span style="color:#f92672">.</span>argmax()
    
    <span style="color:#75715e"># optimize to find the proper location of the optimum</span>
    high_res_max <span style="color:#f92672">=</span> scipy<span style="color:#f92672">.</span>optimize<span style="color:#f92672">.</span>minimize_scalar(i0_min, bounds<span style="color:#f92672">=</span>(low_res_z[low_res_max_idx <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>], low_res_z[low_res_max_idx <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]), method<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;bounded&#39;</span>, options<span style="color:#f92672">=</span>dict(xatol<span style="color:#f92672">=</span><span style="color:#ae81ff">1e-10</span>))
    
    <span style="color:#75715e"># looks like we failed to find a maximum</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> high_res_max<span style="color:#f92672">.</span>success:
        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">RuntimeError</span>(high_res_max<span style="color:#f92672">.</span>message)
    
    <span style="color:#75715e"># make a plot</span>
    <span style="color:#66d9ef">if</span> ax <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> None:
        ax<span style="color:#f92672">.</span>plot(low_res_z, low_res_a)
        ax<span style="color:#f92672">.</span>axvline(high_res_max<span style="color:#f92672">.</span>x, c<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;r&#34;</span>)
    
    
    max_intensity <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>high_res_max<span style="color:#f92672">.</span>fun
    
    <span style="color:#75715e"># return the shifted AFP</span>
    <span style="color:#66d9ef">return</span> high_res_max<span style="color:#f92672">.</span>x <span style="color:#f92672">+</span> NFP, max_intensity


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">find_afp</span>(NFP, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
    <span style="color:#e6db74">&#34;&#34;&#34;A simple version to vectorize over z, for convenience&#34;&#34;&#34;</span>
    <span style="color:#66d9ef">try</span>:
        <span style="color:#66d9ef">return</span> np<span style="color:#f92672">.</span>array([_find_afp(z, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs) <span style="color:#66d9ef">for</span> z <span style="color:#f92672">in</span> NFP])
    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">TypeError</span>:
        <span style="color:#66d9ef">return</span> _find_afp(NFP, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs)
</code></pre></div><h3 id="testing">Testing</h3>
<p>On page 409 of Egner<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup> there are some example calculations that we can repeat to test the validity of the calculations.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">with</span> sns<span style="color:#f92672">.</span>color_palette(<span style="color:#e6db74">&#34;inferno&#34;</span>):
    <span style="color:#75715e"># our confocal calculations</span>
    fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(dpi<span style="color:#f92672">=</span><span style="color:#ae81ff">150</span>)
    
    nfps <span style="color:#f92672">=</span> (<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">25</span>, <span style="color:#ae81ff">30</span>, <span style="color:#ae81ff">50</span>) 
    glycerol_cf <span style="color:#f92672">=</span> find_afp(
        nfps,
        <span style="color:#ae81ff">1.518</span>, <span style="color:#ae81ff">1.473</span>, <span style="color:#ae81ff">1.3</span>, <span style="color:#ae81ff">0.514</span>, <span style="color:#ae81ff">0.59</span>,
        res<span style="color:#f92672">=</span><span style="color:#ae81ff">128</span>, width<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, ax<span style="color:#f92672">=</span>ax
    )

    <span style="color:#75715e"># values taken from table 20.1 of Egner and Hell</span>
    glycerol_lit <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array((
        (<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.28</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.55</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.83</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1.1</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1.33</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1.54</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">2.30</span>),
        (<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0.95</span>, <span style="color:#ae81ff">0.91</span>, <span style="color:#ae81ff">0.78</span>, <span style="color:#ae81ff">0.62</span>, <span style="color:#ae81ff">0.5</span>, <span style="color:#ae81ff">0.4</span>, <span style="color:#ae81ff">0.31</span>)
    ))<span style="color:#f92672">.</span>T

    <span style="color:#75715e"># percent differences between our calculations and theirs for focal shift</span>
    <span style="color:#66d9ef">print</span>((glycerol_lit[:, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">-</span> (glycerol_cf[:, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">-</span> (<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">25</span>, <span style="color:#ae81ff">30</span>, <span style="color:#ae81ff">50</span>))) <span style="color:#f92672">/</span> glycerol_lit[:, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">*</span> <span style="color:#ae81ff">100</span>)

    <span style="color:#75715e"># percent differences between our calculations and theirs for peak intensity</span>
    <span style="color:#66d9ef">print</span>((glycerol_lit[:, <span style="color:#ae81ff">1</span>] <span style="color:#f92672">-</span> glycerol_cf[:, <span style="color:#ae81ff">1</span>] <span style="color:#f92672">/</span> glycerol_cf[:, <span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>max()) <span style="color:#f92672">/</span> glycerol_lit[:, <span style="color:#ae81ff">1</span>] <span style="color:#f92672">*</span> <span style="color:#ae81ff">100</span>)

    ax<span style="color:#f92672">.</span>yaxis<span style="color:#f92672">.</span>set_major_locator(plt<span style="color:#f92672">.</span>NullLocator())
    ax<span style="color:#f92672">.</span>set_xlabel(<span style="color:#e6db74">&#34;Deviation from Nominal Focal Position (µm)&#34;</span>)
    <span style="color:#66d9ef">for</span> line <span style="color:#f92672">in</span> ax<span style="color:#f92672">.</span>get_lines():
        <span style="color:#66d9ef">if</span> len(line<span style="color:#f92672">.</span>get_data()[<span style="color:#ae81ff">0</span>]) <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>:
            line<span style="color:#f92672">.</span>remove()

    ax<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74">&#34;Computation Test, Oil Objective in Glycerol&#34;</span>)
    ax<span style="color:#f92672">.</span>legend(nfps, title<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;NFP (µm)&#34;</span>)
</code></pre></div><pre><code>[        inf  2.2220463   0.62956575  1.5641702   1.51523215 -0.91086836
 -2.9878027   2.47268137]
[ 0.         -2.05250791  2.91190777  2.94368608  1.49427111  6.83299954
 14.99787706 39.09604286]
</code></pre>
<p><img src="output_8_2.png" alt="png"></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">with</span> sns<span style="color:#f92672">.</span>color_palette(<span style="color:#e6db74">&#34;inferno&#34;</span>):
    <span style="color:#75715e"># our confocal calculations</span>
    fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(dpi<span style="color:#f92672">=</span><span style="color:#ae81ff">150</span>)

    nfps <span style="color:#f92672">=</span> (<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">25</span>, <span style="color:#ae81ff">30</span>, <span style="color:#ae81ff">50</span>)
    water_cf <span style="color:#f92672">=</span> find_afp(
        nfps,
        <span style="color:#ae81ff">1.33</span>, <span style="color:#ae81ff">1.473</span>, <span style="color:#ae81ff">1.3</span>, <span style="color:#ae81ff">0.514</span>, <span style="color:#ae81ff">0.59</span>,
        res<span style="color:#f92672">=</span><span style="color:#ae81ff">256</span>, width<span style="color:#f92672">=</span><span style="color:#ae81ff">15</span>, ax<span style="color:#f92672">=</span>ax
    )

    <span style="color:#75715e"># values taken from table 20.1 of Egner and Hell</span>
    water_lit <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array((
        (<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1.0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1.83</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">2.57</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">3.3</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">4.02</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">4.72</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">7.57</span>),
        (<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0.60</span>, <span style="color:#ae81ff">0.39</span>, <span style="color:#ae81ff">0.285</span>, <span style="color:#ae81ff">0.23</span>, <span style="color:#ae81ff">0.19</span>, <span style="color:#ae81ff">0.166</span>, <span style="color:#ae81ff">0.11</span>)
    ))<span style="color:#f92672">.</span>T

    <span style="color:#75715e"># percent differences between our calculations and theirs for focal shift</span>
    <span style="color:#66d9ef">print</span>((water_lit[:, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">+</span> (water_cf[:, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">-</span> (<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">25</span>, <span style="color:#ae81ff">30</span>, <span style="color:#ae81ff">50</span>))) <span style="color:#f92672">/</span> water_lit[:, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">*</span> <span style="color:#ae81ff">100</span>)

    <span style="color:#75715e"># percent differences between our calculations and theirs for peak intensity</span>
    <span style="color:#66d9ef">print</span>((water_lit[:, <span style="color:#ae81ff">1</span>] <span style="color:#f92672">-</span> water_cf[:, <span style="color:#ae81ff">1</span>] <span style="color:#f92672">/</span> water_cf[:, <span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>max()) <span style="color:#f92672">/</span> water_lit[:, <span style="color:#ae81ff">1</span>] <span style="color:#f92672">*</span> <span style="color:#ae81ff">100</span>)

    ax<span style="color:#f92672">.</span>yaxis<span style="color:#f92672">.</span>set_major_locator(plt<span style="color:#f92672">.</span>NullLocator())
    ax<span style="color:#f92672">.</span>set_xlabel(<span style="color:#e6db74">&#34;Deviation from Nominal Focal Position (µm)&#34;</span>)
    <span style="color:#66d9ef">for</span> line <span style="color:#f92672">in</span> ax<span style="color:#f92672">.</span>get_lines():
        <span style="color:#66d9ef">if</span> len(line<span style="color:#f92672">.</span>get_data()[<span style="color:#ae81ff">0</span>]) <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>:
            line<span style="color:#f92672">.</span>remove()

    ax<span style="color:#f92672">.</span>set_xlim(<span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">15</span>)

    ax<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74">&#34;Computation Test, Oil Objective in Water&#34;</span>)
    ax<span style="color:#f92672">.</span>legend(nfps, title<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;NFP (µm)&#34;</span>)
</code></pre></div><pre><code>[        inf -3.89876815 -1.16698752  0.24182932  1.60682485  2.02297875
  3.0281091   5.03027355]
[ 0.         48.28097585 59.70939519 65.5089603  70.36385208 72.25077729
 75.80157613 81.9156686 ]
</code></pre>
<p><img src="output_9_2.png" alt="png"></p>
<p>Our simulations match the reported focal length shift to a few percent. However, there is larger error between the our intensity and theirs.</p>
<h2 id="simulations-for-the-cryo-scope">Simulations for the Cryo-scope</h2>
<p>Here the objective is a 0.85 NA air objective and the sample medium is vitreous ice so $n_1=1$ and $n_2=1.3$.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">with</span> sns<span style="color:#f92672">.</span>color_palette(<span style="color:#e6db74">&#34;inferno&#34;</span>):
    fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(dpi<span style="color:#f92672">=</span><span style="color:#ae81ff">300</span>)
    
    nfps <span style="color:#f92672">=</span> (<span style="color:#f92672">-</span><span style="color:#ae81ff">8</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">8</span>)
    find_afp(nfps, <span style="color:#ae81ff">1.0</span>, <span style="color:#ae81ff">1.3</span>, <span style="color:#ae81ff">0.85</span>, <span style="color:#ae81ff">0.52</span>, res<span style="color:#f92672">=</span><span style="color:#ae81ff">128</span>, ax<span style="color:#f92672">=</span>ax)

    ax<span style="color:#f92672">.</span>yaxis<span style="color:#f92672">.</span>set_major_locator(plt<span style="color:#f92672">.</span>NullLocator())
    ax<span style="color:#f92672">.</span>set_xlabel(<span style="color:#e6db74">&#34;Deviation from Nominal Focal Position (µm)&#34;</span>)
    <span style="color:#66d9ef">for</span> line <span style="color:#f92672">in</span> ax<span style="color:#f92672">.</span>get_lines():
        <span style="color:#66d9ef">if</span> len(line<span style="color:#f92672">.</span>get_data()[<span style="color:#ae81ff">0</span>]) <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>:
            line<span style="color:#f92672">.</span>remove()

    ax<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74">&#34;Computation Test, Air Objective in Ice&#34;</span>)
    ax<span style="color:#f92672">.</span>legend(nfps, title<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;NFP (µm)&#34;</span>)
</code></pre></div><p><img src="output_12_0.png" alt="png"></p>
<p>Clearly, spherical aberrations start to become problematic when you&rsquo;re more than 10 µm from the best focal position (and this effect is worse the larger the mismatch between refractive indices).</p>
<p>One question we can ask is: how well does our geometric argument fare against the more complex vectorial calculation? We&rsquo;ll calculate the actual focal position with the complex calculation for multiple nominal focal positions and compare the to the simpler calculation to see the size of the deviation.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># make some NFPs in µm</span>
NFP <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>linspace(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">8</span>)

<span style="color:#75715e"># calculate the AFPs</span>
AFP <span style="color:#f92672">=</span> find_afp(NFP, <span style="color:#ae81ff">1.0</span>, <span style="color:#ae81ff">1.3</span>, <span style="color:#ae81ff">0.85</span>, <span style="color:#ae81ff">0.52</span>)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># geometrical stretch</span>
geom_m <span style="color:#f92672">=</span> otf_ratio(<span style="color:#ae81ff">1.0</span>, <span style="color:#ae81ff">1.3</span>, <span style="color:#ae81ff">0.85</span>)

fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(dpi<span style="color:#f92672">=</span><span style="color:#ae81ff">150</span>)
ax<span style="color:#f92672">.</span>plot(NFP, AFP[:, <span style="color:#ae81ff">0</span>], <span style="color:#e6db74">&#34;o&#34;</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Vectorial&#34;</span>)
ax<span style="color:#f92672">.</span>plot(NFP, NFP <span style="color:#f92672">*</span> geom_m, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Geometrical&#34;</span>)
ax<span style="color:#f92672">.</span>set_ylabel(<span style="color:#e6db74">&#34;Actual Focal Position (µm)&#34;</span>)
ax<span style="color:#f92672">.</span>set_xlabel(<span style="color:#e6db74">&#34;Nominal Focal Position (µm)&#34;</span>)
ax<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74">&#34;Calculation Comparison&#34;</span>)
ax<span style="color:#f92672">.</span>legend()
</code></pre></div><p><img src="output_15_1.png" alt="png"></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># geometrical stretch</span>
geom_m <span style="color:#f92672">=</span> otf_ratio(<span style="color:#ae81ff">1.0</span>, <span style="color:#ae81ff">1.3</span>, <span style="color:#ae81ff">0.85</span>)

fig, (ax1, ax2) <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(<span style="color:#ae81ff">2</span>, dpi<span style="color:#f92672">=</span><span style="color:#ae81ff">150</span>, sharex<span style="color:#f92672">=</span>True)
ax1<span style="color:#f92672">.</span>plot(NFP, AFP[:, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">-</span> NFP <span style="color:#f92672">*</span> geom_m, <span style="color:#e6db74">&#34;o&#34;</span>)
ax2<span style="color:#f92672">.</span>plot(NFP[<span style="color:#ae81ff">1</span>:], <span style="color:#ae81ff">100</span><span style="color:#f92672">*</span>((AFP[:, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">-</span> NFP <span style="color:#f92672">*</span> geom_m)<span style="color:#f92672">/</span>AFP[:, <span style="color:#ae81ff">0</span>])[<span style="color:#ae81ff">1</span>:], <span style="color:#e6db74">&#34;o&#34;</span>)
ax1<span style="color:#f92672">.</span>set_ylabel(<span style="color:#e6db74">&#34;$\Delta$ (µm)&#34;</span>)
ax2<span style="color:#f92672">.</span>set_ylabel(<span style="color:#e6db74">&#34;$\Delta$ (%)&#34;</span>)
ax2<span style="color:#f92672">.</span>set_xlabel(<span style="color:#e6db74">&#34;Nominal Focal Position (µm)&#34;</span>)
ax1<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74">&#34;Difference between Vectorial and Geometrical Calculations&#34;</span>)
</code></pre></div><p><img src="output_16_1.png" alt="png"></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">slope_ratio <span style="color:#f92672">=</span> (AFP[<span style="color:#ae81ff">1</span>:, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">/</span> NFP[<span style="color:#ae81ff">1</span>:])<span style="color:#f92672">.</span>mean() <span style="color:#f92672">/</span> geom_m
<span style="color:#66d9ef">print</span>(f<span style="color:#e6db74">&#34;The ratio between the complex slope and the simple slope is {slope_ratio:.0%}&#34;</span>)
</code></pre></div><pre><code>The ratio between the complex slope and the simple slope is 99%
</code></pre>
<p>At least as far as focal position is concerned the simple calculation is more than adequate over short distances.</p>
<h2 id="conclusions">Conclusions</h2>
<p>When talking about three dimensional imaging it seems that NA alone doesn&rsquo;t tell the full story.<sup id="fnref:7"><a href="#fn:7" class="footnote-ref" role="doc-noteref">7</a></sup> As shown <a href="#a-question-of-index">above</a>, NA is the sole determinant of lateral resolution but the index of the sample comes into the equation for axial resolution. To put it another way, the lateral resolution of a 0.95 NA water objective is exactly the same (in theory) as the lateral resolution of 0.95 NA air objective <em>but</em> the axial resolution of the water objective is more than 70% worse! Moreover, index mismatch adds spherical aberration to the images. This can be alleviated to a certain extent with confocal imaging (c.f. Figure 1). Even so, it is to the microscopist&rsquo;s advantage to use an objective with a design index as close as possible to the sample of interest (except in the case of TIRF microscopy).</p>
<p>If you want to download the Jupyter notebook I used to create this post you can do so <a href="/files/Vectorial%20Estimation%20of%20focal%20shift.ipynb" target="_blank">here</a>.</p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p><a href="https://www.osapublishing.org/josaa/abstract.cfm?uri=josaa-12-2-325">P. Török, P. Varga, Z. Laczik, G. R. Booker, Electromagnetic diffraction of light focused through a planar interface between materials of mismatched refractive indices: an integral representation. J. Opt. Soc. Am. A, JOSAA. 12, 325–332 (1995).</a> <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p><a href="http://onlinelibrary.wiley.com/doi/10.1046/j.1365-2818.1997.2440802.x/abstract">P. Török, S. J. Hewlett, P. Varga, The role of specimen-induced spherical aberration in confocal microscopy. Journal of Microscopy. 188, 158–172 (1997).</a> <a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3" role="doc-endnote">
<p><a href="https://link.springer.com/chapter/10.1007/978-0-387-45524-2_20">A. Egner, S. W. Hell, in Handbook Of Biological Confocal Microscopy (Springer, Boston, MA, 2006; https://link.springer.com/chapter/10.1007/978-0-387-45524-2_20), pp. 404–413.</a> <a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4" role="doc-endnote">
<p>It should be noted that <a href="https://en.wikipedia.org/wiki/Fresnel_equations">Fresnel reflections</a> at the interface increase with increasing angle such that the apodization function of the pupil rolls off much faster. Thus while the lateral support of the OTF is unchanged its actual shape will be different and will result in lower <em>effective</em> resolution at lower signal-to-noise ratios. <a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:5" role="doc-endnote">
<p><a href="https://onlinelibrary.wiley.com/doi/abs/10.1111/j.1365-2818.1988.tb04563.x">C. J. R. Sheppard, Depth of field in optical microscopy. Journal of Microscopy. 149, 73–75 (1988).</a> <a href="#fnref:5" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:6" role="doc-endnote">
<p>Squishing in frequency which is expansion in real space. <a href="#fnref:6" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:7" role="doc-endnote">
<p>This is definitely true for two dimensional imaging as well: characterizing the frequency response of any system with a single number is always a bad idea. In practice, how the OTF approaches zero transmission is as import, if not more so, than where it hits zero. If your microscope transmits high spatial frequencies, but strongly attenuates them, you&rsquo;ll need a high, and in some cases an unphysically high, signal to noise ratio to make use of them. <a href="#fnref:7" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>

    </div>

    

<div class="article-tags">
  
  <a class="badge badge-light" href="/tags/microscopy/">microscopy</a>
  
  <a class="badge badge-light" href="/tags/optics/">optics</a>
  
  <a class="badge badge-light" href="/tags/theory/">theory</a>
  
  <a class="badge badge-light" href="/tags/resolution/">resolution</a>
  
</div>



    
      








  
  
    
  
  





  
  
  
    
  
  
  <div class="media author-card" itemscope itemtype="http://schema.org/Person">
    

    <div class="media-body">
      <h5 class="card-title" itemprop="name"><a href="https://david-hoffman.github.io/">David P. Hoffman</a></h5>
      <h6 class="card-subtitle">Staff Optical Engineer @ <a href="https://www.10xgenomics.com/">10x Genomics</a></h6>
      <p class="card-text" itemprop="description">I&rsquo;m a scientist/engineer who builds robust, high-performance optical systems and loves data and python. Views are my own (whose else’s would they be?)</p>
      <ul class="network-icon" aria-hidden="true">
        
          
          
          
            
          
          
          
          
          
            
          
          <li>
            <a itemprop="sameAs" href="/#contact" >
              <i class="fas fa-envelope"></i>
            </a>
          </li>
        
          
          
          
            
          
          
          
          
          
            
          
          <li>
            <a itemprop="sameAs" href="https://twitter.com/davephoffman" target="_blank" rel="noopener">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
        
          
          
          
            
          
          
          
          
          
            
          
          <li>
            <a itemprop="sameAs" href="https://www.linkedin.com/in/dphoffman/" target="_blank" rel="noopener">
              <i class="fab fa-linkedin"></i>
            </a>
          </li>
        
          
          
          
            
          
          
          
          
          
            
          
          <li>
            <a itemprop="sameAs" href="https://github.com/david-hoffman" target="_blank" rel="noopener">
              <i class="fab fa-github"></i>
            </a>
          </li>
        
          
          
          
            
          
          
          
          
          
            
          
          <li>
            <a itemprop="sameAs" href="https://stackoverflow.com/users/5030014/david-hoffman" target="_blank" rel="noopener">
              <i class="fab fa-stack-overflow"></i>
            </a>
          </li>
        
          
          
          
          
          
          
          
            
          
          <li>
            <a itemprop="sameAs" href="https://scholar.google.com/citations?user=HGG__poAAAAJ&amp;hl=en" target="_blank" rel="noopener">
              <i class="ai ai-google-scholar"></i>
            </a>
          </li>
        
          
          
          
          
          
          
          
            
          
          <li>
            <a itemprop="sameAs" href="/files/cv.pdf" >
              <i class="ai ai-cv"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>



      
      
      <div class="article-widget">
        <div class="hr-light"></div>
        <h3>Related</h3>
        <ul>
          
          <li><a href="/post/angle-to-position-and-back/">Angle to Position and Back</a></li>
          
          <li><a href="/publication/clem/">Freeze-frame of whole cells</a></li>
          
        </ul>
      </div>
      
    

    

    


  </div>
</article>

      

    
    
    
    <script src="/js/mathjax-config.js"></script>
    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" integrity="sha256-X5PoE3KU5l+JcX+w09p/wHl9AzK333C4hJ2I9S5mD4M=" crossorigin="anonymous"></script>

      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js" integrity="sha256-aYTdUrn6Ow1DDgh5JTc3aDGnnju48y/1c8s1dgkYPQ8=" crossorigin="anonymous"></script>
        
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/python.min.js"></script>
        
      

      
      
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS_CHTML-full" integrity="sha256-GhM+5JHb6QUzOQPXSJLEWP7R73CbkisjzK5Eyij4U9w=" crossorigin="anonymous" async></script>
      
    

    
    

    
    
    

    
    
    <script>hljs.initHighlightingOnLoad();</script>
    

    

    
    

    

    
    

    
    

    
    
    
    
    
    
    
    
    
    
    
    
    <script src="/js/academia.min.7276a6a3624de715a5c7f54c7c07696d.js"></script>

    






  
  <div class="container">
    <footer class="site-footer">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-md-6 mb-4 mb-md-0">
        
        <p class="mb-0">
          © 2022 David P. Hoffman &middot; 
          Powered by
          <a href="https://gethugothemes.com" target="_blank" rel="noopener">Gethugothemes</a>
        </p>
      </div>
      <div class="col-md-6">
        <ul class="list-inline network-icon text-right mb-0">
          
          
          
          
          
          
          
          
          
          
          
          
          
          <li class="list-inline-item">
            <a href="https://www.linkedin.com/in/dphoffman/" target="_blank" rel="noopener" title="Linkin with me"><i class="fab fa-linkedin" aria-hidden="true"></i></a>
          </li>
          
          
          
          
          
          
          
          
          
          
          
          
          <li class="list-inline-item">
            <a href="https://twitter.com/davephoffman" target="_blank" rel="noopener" title="DM Me"><i class="fab fa-twitter" aria-hidden="true"></i></a>
          </li>
          
          
          
          
          
          
          
          
          
          
          
          
          <li class="list-inline-item">
            <a href="https://github.com/david-hoffman" target="_blank" rel="noopener" title="Check out my code"><i class="fab fa-github" aria-hidden="true"></i></a>
          </li>
          
        </ul>
      </div>
    </div>
  </div>
</footer>
  </div>
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
